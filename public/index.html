<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Estiim – T-Shirt Estimator</title>
<!-- Lucide CDN script re-added for SVG icons -->
<script src="https://cdn.jsdelivr.net/npm/lucide@latest"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;display=swap');
:root { --bg:#f3f4f6; --card:#fff; --border:#e5e7eb; --primary:#2ecc71; --primary-dark:#27ae60; --text:#111827; --overlay:rgba(0,0,0,0.4); --orange:#f97316; --orange-dark:#ea580c; --red:#ef4444; --green:#22c55e; --blue: #007bff; --blue-dark: #0056b3;} /* Added blue colors */
/* Added scroll-padding-top to account for sticky header */
html, body { scroll-behavior: smooth; scroll-padding-top: 60px; /* Adjust this value if header height changes */ }
* { box-sizing:border-box; font-family:Inter,Arial,sans-serif; }
body { margin:0; background:var(--bg); color:var(--text); }
header { background:var(--primary); color:#fff; padding:12px 24px; display:flex; justify-content:space-between; align-items:center; position:sticky; top:0; z-index:1001; /* Ensure header is above flyout */ }
header h1 { margin:0; font-size:22px; font-weight:600; cursor:pointer; }
/* Removed nav a styles */
section { display:none; padding:24px 10vw; }
section.active { display:block; }
.card { background:var(--card); padding:20px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,.05); margin-bottom:24px; }
h2 { margin:0 0 12px; font-size:18px; font-weight:600; }
button, input, select, textarea { font-size:14px; padding:8px 10px; border-radius:6px; border:1px solid var(--border); }
button { background:var(--primary); color:#fff; border:none; cursor:pointer; }
button:hover { background:var(--primary-dark); }
table { width:100%; border-collapse:collapse; margin-top:12px; }
th, td { border:1px solid var(--border); padding:8px; text-align:left; }
th { background:#f9fafb; }
.flex { display:flex; gap:12px; flex-wrap:wrap; }
input[type=number] { width:90px; }
.modal-overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:var(--overlay); display:none; align-items:center; justify-content:center; z-index:1000; }
.modal { background:var(--card); padding:24px; border-radius:8px; max-width:900px; /* Increased max-width for two columns */ width:90%; position:relative; box-shadow:0 4px 8px rgba(0,0,0,.1); }
.modal h2 { margin-top:0; }
.modal .close { position:absolute; top:12px; right:16px; background:none; border:none; font-size:18px; cursor:pointer; color:var(--text); }
.modal pre { white-space:pre-wrap; background:#f3f4f6; padding:10px; border-radius:4px; max-height:300px; overflow-y:auto; }
.audit-container { max-height: 400px; overflow-y: auto; }
.audit-item { margin-bottom: 15px; padding: 10px; border: 1px solid var(--border); border-radius: 6px; }
.audit-item h4 { margin: 0 0 8px; font-size: 16px; }
.diff-added { color: var(--green); }
.diff-removed { color: var(--red); text-decoration: line-through; }
.export-button {
    background-color: #007bff; /* Blue color */
    color: white;
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
    border-radius: 6px;
    border: none;
    cursor: pointer;
}
.export-button:hover {
    background-color: #0056b3; /* Darker blue on hover */
}
.import-button {
    background-color: var(--orange); /* Orange color */
    color: white;
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
    border-radius: 6px;
    border: none;
    cursor: pointer;
}
.import-button:hover {
    background-color: var(--orange-dark); /* Darker orange on hover */
}
/* New style for duplicate button */
.dup-button {
    background-color: var(--blue);
    color: white;
}
.dup-button:hover {
    background-color: var(--blue-dark);
}
footer {
    position: fixed;
    bottom: 0;
    width: 100%;
    text-align: center;
    color: #aaa;
    padding: 5px;
    font-size: 12px;
}
.factor-calc {
    position: absolute;
    top: 24px;
    right: 24px;
    font-size: 12px;
    text-align: right;
    line-height: 1.5;
    background-color: #e6f7ff; /* Light blue background */
    padding: 8px 12px;
    border-radius: 6px;
    display: flex; /* Make it horizontal */
    gap: 12px;
    align-items: center;
}
.factor-calc > div {
    white-space: nowrap;
}

/* New styles for factor items and custom checkboxes */
.factor-item {
    display: flex;
    align-items: center;
    gap: 10px; /* Space between checkbox/label and quantity */
    margin-bottom: 8px;
    padding: 5px 0;
    border: 1px solid var(--border); /* Added border for clarity */
    border-radius: 66px; /* Increased border-radius for more rounded corners */
    padding: 10px;
    background-color: var(--card);
    box-shadow: 0 1px 2px rgba(0,0,0,.03);
    flex-wrap: wrap; /* Allow content to wrap */
}

.factor-item-content {
    flex-grow: 1; /* Allows content to take available space */
    display: flex;
    flex-direction: column; /* Stack name and resources vertically */
}

.factor-name {
    font-weight: 600;
    color: var(--text);
    margin-bottom: 4px; /* Space between name and resources */
}

.factor-resources {
    font-size: 0.85em;
    color: #555;
}

/* Custom checkbox styling */
.custom-checkbox {
    display: flex;
    align-items: center;
    cursor: pointer;
    position: relative;
    padding-left: 25px; /* Space for the custom box */
    user-select: none;
    min-height: 18px; /* Ensure enough height for the label text */
    margin-right: 10px; /* Space between checkbox and factor content */
}

.custom-checkbox input[type="checkbox"] {
    position: absolute;
    opacity: 0; /* Hide default checkbox */
    cursor: pointer;
    height: 0;
    width: 0;
}

.checkmark {
    position: absolute;
    top: 0;
    left: 0;
    height: 18px;
    width: 18px;
    background-color: #eee;
    border-radius: 4px;
    border: 1px solid var(--border);
    transition: background-color 0.2s, border-color 0.2s;
}

.custom-checkbox:hover input ~ .checkmark {
    background-color: #ccc;
}

.custom-checkbox input:checked ~ .checkmark {
    background-color: var(--primary);
    border-color: var(--primary);
}

.checkmark:after {
    content: "";
    position: absolute;
    display: none;
}

.custom-checkbox input:checked ~ .checkmark:after {
    left: 6px;
    top: 2px;
    width: 5px;
    height: 10px;
    border: solid white;
    border-width: 0 2px 2px 0;
    transform: rotate(45deg);
}

/* Quantity input styling for better appearance */
.factor-item input[type="number"] {
    flex-shrink: 0; /* Prevent shrinking */
    width: 70px; /* Smaller width for quantity */
    transition: all 0.3s ease-in-out; /* Smooth transition for display */
    opacity: 1; /* Default visible */
    pointer-events: auto; /* Default interactive */
}

.factor-item input[type="number"][style*="display: none"] {
    opacity: 0;
    pointer-events: none;
    width: 0; /* Collapse width when hidden */
    padding-left: 0;
    padding-right: 0;
    border: none; /* Hide border when collapsed */
}

/* Table header sortable styles */
.sortable-th {
    cursor: pointer;
    position: relative;
    padding-right: 20px; /* Space for arrow */
}

.sortable-th .sort-arrow {
    position: absolute;
    right: 5px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 0.8em;
    color: #888;
}

/* Journal styles */
.journal-entry {
    padding: 8px;
    border-bottom: 1px dashed var(--border);
    font-size: 0.9em;
    color: #555;
}
.journal-entry:last-child {
    border-bottom: none;
}
.journal-entry .timestamp {
    font-weight: 600;
    color: #333;
    margin-bottom: 4px;
    display: block;
}
.journal-entry.audit {
    background-color: #f0f8ff; /* Light blue for audit entries */
    border-left: 3px solid var(--primary);
    padding-left: 5px;
}
.journal-entry.audit .audit-summary {
    font-style: italic;
    color: #666;
}


/* Modal layout for initiative */
.modal-content-flex {
    display: flex;
    gap: 24px; /* Space between columns */
    flex-wrap: wrap; /* Allows columns to wrap on smaller screens */
}

.initiative-details-left {
    flex: 2; /* Takes more space on larger screens */
    min-width: 300px; /* Minimum width before wrapping */
}

.initiative-journal-right {
    flex: 1; /* Takes less space, but grows */
    min-width: 250px; /* Minimum width before wrapping */
    display: flex; /* Flex container for its own content */
    flex-direction: column; /* Stack journal elements vertically */
}

/* New style for calculated shirt size */
.calculated-shirt-size {
    font-size: 1.2em; /* Slightly larger font */
    font-weight: bold; /* Bold text */
    margin-top: 16px; /* Space above */
    margin-bottom: 8px; /* Space below */
}

/* Adjustments for smaller screens */
@media (max-width: 768px) {
    .modal-content-flex {
        flex-direction: column; /* Stack columns vertically */
    }
    .initiative-details-left,
    .initiative-journal-right {
        min-width: unset; /* Remove min-width to allow full width */
        width: 100%;
    }
}

/* Custom Message Box Styles */
.message-box-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: var(--overlay);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 2000; /* Higher than other modals */
    display: none; /* Hidden by default */
}

.message-box {
    background: var(--card);
    padding: 24px;
    border-radius: 8px;
    max-width: 400px;
    width: 90%;
    box-shadow: 0 44px 8px rgba(0,0,0,.1);
    text-align: center;
}

.message-box h3 {
    margin-top: 0;
    font-size: 20px;
    color: var(--text);
}

.message-box p {
    margin-bottom: 20px;
    color: #555;
}

.message-box button {
    background-color: var(--primary);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 6px;
    cursor: pointer;
}

.message-box button:hover {
    background-color: var(--primary-dark);
}

.message-box.success h3 {
    color: var(--green);
}

.message-box.error h3 {
    color: var(--red);
}

/* Styles for scrollable factor picker and search */
#factor-picker-container {
    max-height: 300px; /* Cap at roughly 6 items + padding */
    overflow-y: auto;
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 10px;
    background-color: #f9fafb;
    margin-top: 12px;
}

#factor-search-input {
    width: 100%;
    margin-bottom: 12px;
    padding: 8px 10px;
    border: 1px solid var(--border);
    border-radius: 6px;
}

/* Flyout menu styles */
.flyout-menu-container {
    position: absolute;
    top: 0;
    right: 0;
    height: 100%; /* Occupy full height of the header */
    display: flex;
    align-items: center;
    padding-right: 24px; /* Match header padding */
}

.gear-icon {
    cursor: pointer;
    width: 28px; /* Slightly larger icon */
    height: 28px;
    color: #fff;
    transition: transform 0.3s ease-in-out; /* Re-added transition for SVG */
    transform-origin: center center; /* Ensure rotation around center */
}

.gear-icon:hover {
    transform: rotate(90deg); /* Re-added rotation for SVG */
}

.flyout-menu {
    position: fixed; /* Fixed position relative to viewport */
    top: 0;
    right: 0;
    width: 250px; /* Width of the flyout menu */
    height: 100%;
    background-color: var(--primary-dark); /* Darker background for distinction */
    box-shadow: -4px 0 8px rgba(0,0,0,0.2);
    transform: translateX(100%); /* Start off-screen to the right */
    transition: transform 0.3s ease-in-out;
    padding-top: 60px; /* Space for header */
    z-index: 1000; /* Below header, above content */
    display: flex;
    flex-direction: column;
}

.flyout-menu.active {
    transform: translateX(0); /* Slide into view */
}

.flyout-menu a {
    color: #fff;
    padding: 15px 24px;
    text-decoration: none;
    font-weight: 500;
    border-bottom: 1px solid rgba(255,255,255,0.1); /* Subtle separator */
    transition: background-color 0.2s;
}

.flyout-menu a:hover {
    background-color: rgba(0,0,0,0.1); /* Slight hover effect */
}

.flyout-menu .close-btn {
    position: absolute;
    top: 12px;
    right: 16px;
    font-size: 24px;
    color: #fff;
    background: none;
    border: none;
    cursor: pointer;
    padding: 5px;
}

/* Styles for scrollable estimation factors table and its search */
#ef-table-container {
    max-height: 225px; /* 5 items * ~45px height per row */
    overflow-y: auto;
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 10px;
    background-color: #f9fafb;
}

#ef-search-input {
    flex-grow: 1; /* Allow it to take available space */
    margin-right: 12px; /* Space between search and add button */
    padding: 8px 10px;
    border: 1px solid var(--border);
    border-radius: 6px;
    font-size: 14px;
}

/* Styles for Initiatives table container */
#init-table-container {
    max-height: 360px; /* 8 items * ~45px height per row */
    overflow-y: auto;
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 10px;
    background-color: #f9fafb;
}

/* Styles for Resource Types table container */
#rt-table-container {
    max-height: 225px; /* 5 items * ~45px height per row */
    overflow-y: auto;
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 10px;
    background-color: #f9fafb;
}

/* Styles for search inputs on main pages */
.main-page-search-input {
    flex-grow: 1; /* Allow it to take available space */
    margin-right: 12px; /* Space between search and add button */
    padding: 8px 10px;
    border: 1px solid var(--border);
    border-radius: 6px;
    font-size: 14px;
}

</style>
</head>
<body>
<header id="main-header">
  <h1 onclick="window.location.href = '/'">Estiim</h1>
  <div class="flyout-menu-container">
    <!-- Double Gear Icon SVG from provided code -->
    <svg class="gear-icon" onclick="window.toggleFlyoutMenu()" height="28px" width="28px" version="1.1" id="_x32_" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
	 viewBox="0 0 512 512" xml:space="preserve">
        <style type="text/css">
            .st0{fill:#FFFFFF;} /* Changed fill to white */
        </style>
        <g>
            <path class="st0" d="M336.896,269.874c-18.795,0-36.449,7.308-49.698,20.575c-13.276,13.267-20.593,30.912-20.593,49.698
                c0,18.768,7.307,36.422,20.593,49.707c13.276,13.267,30.921,20.574,49.698,20.574c18.769,0,36.422-7.307,49.698-20.574
                c13.276-13.286,20.584-30.939,20.584-49.707c0-18.778-7.307-36.43-20.574-49.689C373.336,277.182,355.682,269.874,336.896,269.874z
                M378.1,381.35c-11.011,11.003-25.636,17.061-41.204,17.061c-15.559,0-30.202-6.058-41.204-17.061
                c-11.011-11.002-17.07-25.635-17.07-41.203c0-15.568,6.058-30.202,17.07-41.195c11.002-11.011,25.645-17.069,41.204-17.069
                c15.568,0,30.193,6.058,41.204,17.069c11.002,10.993,17.06,25.627,17.06,41.195C395.161,355.715,389.102,370.348,378.1,381.35z"/>
            <path class="st0" d="M499.041,317.118l-37.455-5.428c-2.346-0.18-4.368-1.654-5.277-3.838l-12.134-29.294
                c-0.908-2.175-0.531-4.656,1.006-6.436l22.4-30.103c3.569-4.18,3.335-10.392-0.556-14.274l-17.726-17.726
                c-2.04-2.05-4.736-3.083-7.433-3.083c-2.427,0-4.863,0.836-6.832,2.526l-30.112,22.409c-1.141,0.98-2.588,1.492-4.044,1.492
                c-0.809,0-1.618-0.162-2.382-0.476l-29.312-12.153c-2.166-0.89-3.65-2.94-3.838-5.268l-5.438-37.455
                c-0.422-5.484-4.989-9.708-10.472-9.708h-25.078c-5.492,0-10.059,4.224-10.481,9.708l-5.447,37.455
                c-0.179,2.328-1.654,4.378-3.829,5.276l-29.312,12.144c-0.773,0.314-1.582,0.476-2.39,0.476c-1.456,0-2.895-0.512-4.045-1.492
                l-30.094-22.4c-1.969-1.69-4.404-2.535-6.822-2.535c-2.706,0-5.402,1.043-7.452,3.092l-17.726,17.717
                c-3.883,3.892-4.116,10.094-0.557,14.274l22.4,30.103c1.519,1.779,1.914,4.26,1.016,6.436l-12.144,29.303
                c-0.881,2.175-2.931,3.65-5.258,3.829l-37.474,5.438c-5.464,0.432-9.689,4.998-9.689,10.49v25.06
                c0,5.502,4.225,10.068,9.689,10.498l37.474,5.43c2.328,0.189,4.378,1.672,5.258,3.838l12.144,29.311
                c0.907,2.158,0.503,4.656-1.016,6.436l-22.4,30.103c-3.559,4.161-3.326,10.382,0.557,14.265l17.726,17.726
                c2.05,2.049,4.746,3.082,7.443,3.082c2.427,0,4.863-0.836,6.832-2.526l30.094-22.409c1.15-0.98,2.589-1.483,4.045-1.483
                c0.809,0,1.617,0.152,2.39,0.476L304.6,459.57c2.175,0.899,3.659,2.93,3.838,5.276l5.438,37.456
                c0.422,5.464,4.989,9.698,10.481,9.698h25.078c5.492,0,10.049-4.234,10.481-9.698l5.429-37.456
                c0.189-2.345,1.672-4.376,3.838-5.276l29.312-12.144c0.773-0.324,1.581-0.476,2.39-0.476c1.456,0,2.904,0.503,4.045,1.483
                l30.103,22.409c1.969,1.69,4.404,2.526,6.832,2.526c2.697,0,5.393-1.034,7.433-3.082l17.726-17.726
                c3.9-3.883,4.125-10.104,0.556-14.265l-22.4-30.103c-1.509-1.78-1.914-4.279-1.006-6.436l12.134-29.311
                c0.909-2.167,2.931-3.65,5.277-3.838l37.455-5.43c5.474-0.431,9.699-4.997,9.699-10.48v-25.078
                C508.74,322.125,504.515,317.559,499.041,317.118z M496.722,351.364l-36.574,5.304c-6.643,0.71-12.324,4.944-14.939,11.182
                l-12.126,29.266c-2.598,6.22-1.582,13.25,2.633,18.481l21.879,29.402l-15.856,15.855l-29.392-21.878
                c-3.236-2.616-7.29-4.054-11.461-4.054c-2.436,0-4.808,0.485-6.984,1.402l-29.339,12.152c-6.211,2.589-10.444,8.278-11.155,14.93
                l-5.302,36.574h-22.418l-5.312-36.565c-0.701-6.652-4.926-12.35-11.173-14.957l-29.276-12.117c-2.238-0.944-4.602-1.42-7.028-1.42
                c-4.153,0-8.198,1.438-11.443,4.044l-29.411,21.887l-15.847-15.855l21.87-29.402c4.224-5.232,5.24-12.27,2.652-18.446
                l-12.117-29.248c-2.553-6.256-8.252-10.517-14.94-11.236l-36.592-5.304v-22.436l36.575-5.303
                c6.714-0.701,12.422-4.98,14.929-11.164l12.126-29.267c2.606-6.22,1.591-13.258-2.633-18.48l-21.879-29.411l15.865-15.856
                l29.383,21.878c3.245,2.624,7.29,4.054,11.461,4.054c2.409,0,4.763-0.468,6.992-1.393l29.303-12.144
                c6.23-2.571,10.481-8.278,11.173-14.948l5.321-36.566h22.418l5.302,36.584c0.72,6.669,4.972,12.369,11.173,14.921l29.312,12.153
                c2.22,0.916,4.575,1.393,6.984,1.393c4.18,0,8.234-1.438,11.47-4.054l29.392-21.878l15.856,15.856l-21.86,29.375
                c-4.243,5.214-5.268,12.26-2.661,18.471l12.135,29.312c2.588,6.22,8.288,10.462,14.948,11.164l36.565,5.303V351.364z"/>
            <path class="st0" d="M186.04,154.802c6.499-13.987,7.173-29.663,1.888-44.135c-5.294-14.48-15.891-26.04-29.842-32.521
                c-7.792-3.64-16.062-5.465-24.575-5.429c-6.651,0.027-13.231,1.213-19.559,3.524c-14.498,5.285-26.057,15.883-32.556,29.86
                c-6.499,13.96-7.173,29.626-1.897,44.134c5.304,14.49,15.911,26.049,29.861,32.53c7.784,3.622,16.053,5.455,24.565,5.42
                c6.661-0.036,13.241-1.222,19.578-3.524C167.965,179.377,179.515,168.77,186.04,154.802z M149.376,173.372
                c-5.042,1.843-10.282,2.769-15.505,2.787c-6.634,0.036-13.25-1.403-19.442-4.288c-11.065-5.151-19.442-14.302-23.64-25.762
                c-4.17-11.478-3.65-23.882,1.501-34.939c5.151-11.074,14.31-19.469,25.77-23.639c5.051-1.852,10.292-2.778,15.506-2.796
                c6.634-0.028,13.24,1.411,19.433,4.297c11.056,5.15,19.451,14.301,23.64,25.761c4.18,11.47,3.648,23.865-1.493,34.939
                C169.978,160.797,160.837,169.184,149.376,173.372z"/>
        </g>
    </svg>
  </div>
</header>

<!-- Flyout Menu -->
<div id="flyout-menu" class="flyout-menu">
    <button class="close-btn" onclick="window.toggleFlyoutMenu()">×</button>
    <a href="#home" onclick="window.show('#home')">Home</a>
    <a href="#factors" onclick="window.show('#factors')">Estimation Factors</a>
    <a href="#shirt-sizes" onclick="window.show('#shirt-sizes')">Shirt Sizes</a>
    <a href="#prefs" onclick="window.show('#prefs')">Prefs</a>
</div>

<section id="home" class="active">
  <div class="card flex" style="justify-content:space-between;align-items:center;">
    <h2>Initiatives</h2>
    <div class="flex">
        <!-- New search input for the main initiatives page -->
        <input type="text" id="init-search-input" class="main-page-search-input" placeholder="Search initiatives..." oninput="window.loadInitiatives(currentSortColumn, currentSortDirection)">
        <button onclick="window.addInitiative()">+ Add Initiative</button>
        <button class="export-button" onclick="window.exportInitiatives()">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-download"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg> Export
        </button>
        <button class="export-button" onclick="window.exportResourceView()">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-download"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg> Export Resource View
        </button>
        <button class="import-button" onclick="window.importInitiatives()">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-upload"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg> Import
        </button>
        <input type="file" id="importFileInput" accept=".tsv" style="display: none;" onchange="window.handleImportFile(event)">
    </div>
  </div>
  <div id="init-table-container" class="card">
    <table id="init-table">
        <thead>
            <tr>
                <th class="sortable-th" data-sort="id">Internal ID<span class="sort-arrow"></span></th>
                <th class="sortable-th" data-sort="custom_id">User-Defined ID<span class="sort-arrow"></span></th>
                <th class="sortable-th" data-sort="name">Name<span class="sort-arrow"></span></th>
                <th class="sortable-th" data-sort="status">Status<span class="sort-arrow"></span></th>
                <th class="sortable-th" data-sort="shirt_size">Shirt Size<span class="sort-arrow"></span></th>
                <th class="sortable-th" data-sort="computed_hours">Estimated Hours<span class="sort-arrow"></span></th>
                <th class="sortable-th" data-sort="start_date">Start Date<span class="sort-arrow"></span></th>
                <th class="sortable-th" data-sort="end_date">End Date<span class="sort-arrow"></span></th>
                <th class="sortable-th" data-sort="created_at">Created<span class="sort-arrow"></span></th>
                <th class="sortable-th" data-sort="updated_at">Updated<span class="sort-arrow"></span></th>
                <th></th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
  </div>
</section>

<section id="factors">
  <div class="card">
    <div class="flex" style="justify-content:space-between;align-items:center;">
        <h2>Resource Types</h2>
        <!-- New search input for the main resource types page -->
        <input type="text" id="rt-search-input" class="main-page-search-input" placeholder="Search resource types..." oninput="window.loadRT()">
        <button onclick="window.openAddResourceTypeModal()">+ Add Resource Type</button>
    </div>
    <div id="rt-table-container" class="card">
        <table id="rt-table"><thead><tr><th>Name</th><th>Description</th><th></th></tr></thead><tbody></tbody></table>
    </div>
  </div>

  <div class="card" style="margin-top: 24px;">
    <div class="flex" style="justify-content:space-between;align-items:center; margin-bottom: 12px;">
        <h2>Estimation Factors</h2>
        <!-- Existing search input for the main factors page -->
        <input type="text" id="ef-search-input" class="main-page-search-input" placeholder="Search factors..." oninput="window.loadEF()">
        <button onclick="window.addEstimationFactor()">+ Add Estimation Factor</button>
    </div>
    <!-- Existing container for scrollable estimation factors table -->
    <div id="ef-table-container" class="card">
        <table id="ef-table"><thead><tr><th>Name</th><th>Resources</th><th>Days</th><th>Hours</th><th></th></tr></thead><tbody></tbody></table>
    </div>
  </div>
</section>

<section id="shirt-sizes">
    <div class="card flex" style="justify-content:space-between;align-items:center;">
        <h2>Shirt Size Configuration</h2>
        <div><button onclick="window.saveShirtSizes()">Save</button><button onclick="window.loadShirtSizes()" style="background:var(--border);color:var(--text)">Cancel</button><button onclick="window.showShirtSizeAuditTrail()" style="margin-left:8px;">🔍 Audit</button></div>
    </div>
    <div class="card">
        <p>Set the minimum estimated hours for each T-shirt size.</p>
        <table id="shirt-size-table"><thead><tr><th>Size</th><th>Hours</th><th>Days</th><th>Months</th></tr></thead><tbody></tbody></table>
    </div>
</section>

<!-- New Prefs Section -->
<section id="prefs">
    <div class="card flex" style="justify-content:space-between;align-items:center;">
        <h2>Preferences</h2>
        <div>
            <button onclick="window.savePreferences()">Save</button>
            <button onclick="window.populatePrefsPage()" style="background:var(--border);color:var(--text)">Cancel</button>
        </div>
    </div>
    <div class="card">
        <p>Configure display limits for lists:</p>
        <div style="margin-bottom: 12px;">
            <label for="pref-max-initiatives" style="display: inline-block; width: 180px;">Max Visible Initiatives:</label>
            <input type="number" id="pref-max-initiatives" min="1" value="8">
        </div>
        <div style="margin-bottom: 12px;">
            <label for="pref-max-resource-types" style="display: inline-block; width: 180px;">Max Visible Resource Types:</label>
            <input type="number" id="pref-max-resource-types" min="1" value="5">
        </div>
        <div>
            <label for="pref-max-estimation-factors" style="display: inline-block; width: 180px;">Max Visible Estimation Factors:</label>
            <input type="number" id="pref-max-estimation-factors" min="1" value="5">
        </div>
    </div>
</section>


<!-- Modals -->
<div id="modal-init" class="modal-overlay"><div class="modal">
    <button class="close" onclick="window.closeModal('init')">×</button>
    <h2>Add / Edit Initiative</h2>
    <input id="init-id" type="hidden">
    
    <div class="modal-content-flex">
        <div class="initiative-details-left">
            <div class="flex"><input id="init-name" placeholder="Name" style="flex:1"><input id="init-custom-id" placeholder="User-Defined ID" style="flex:1"></div>
            <textarea id="init-desc" placeholder="Description" style="width:100%;margin-top:12px"></textarea>
            <div class="flex" style="margin-top:12px"><div><label>Priority</label><br><select id="init-priority"><option>Low</option><option>Medium</option><option>High</option></select></div><div><label>Pri #</label><br><input id="init-priority-num" type="number" min="1" max="10"></div><div><label>Status</label><br><select id="init-status"><option>To Do</option><option>Draft</option><option>Proposal</option><option>Re-Estimation</option><option>Accepted</option><option>Rejected</option></select></div></div>
            <div class="flex" style="margin-top:12px"><div><label>Start Date</label><br><input id="init-start-date" type="date"></div><div><label>End Date</label><br><input id="init-end-date" type="date"></div></div>
            <textarea id="init-scope" placeholder="In Scope" style="width:100%;margin-top:12px"></textarea>
            <textarea id="init-out" placeholder="Out of Scope" style="width:100%;margin-top:12px"></textarea>
            
            <!-- Calculated T-Shirt Size moved here -->
            <div class="calculated-shirt-size" id="init-calculated-shirt-size"></div>

            <div style="margin-top:16px">
                <h3>T-Shirt Factors</h3>
                <div id="selected-factors-summary"></div>
                <button style="margin-top:8px;" onclick="window.openFactorModal()">Select Factors</button>
            </div>
        </div>

        <!-- Journal Section -->
        <div class="initiative-journal-right">
            <div class="flex" style="margin-bottom:12px;">
                <div style="flex:1;"><label><b>Created</b></label><br><span id="init-created"></span></div>
                <div style="flex:1;"><label><b>Updated</b></label><br><span id="init-updated"></span></div>
            </div>
            <h3>Journal</h3>
            <div id="initiative-journal-log" style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border); padding: 10px; border-radius: 6px; background: #f9fafb; flex-grow: 1;"></div>
            <textarea id="journal-comment-input" placeholder="Add a new comment..." style="width:100%; margin-top:10px; min-height: 60px;"></textarea>
            <button onclick="window.addJournalComment()" style="margin-top:8px;">Add Comment</button>
        </div>
    </div>

    <div class="flex" style="justify-content:flex-end;margin-top:16px">
        <button class="dup-button" onclick="window.duplicateInitiative()">Dup</button> <!-- New Dup button -->
        <button onclick="window.saveInitiative()">Save</button>
        <button onclick="window.closeModal('init')" style="background:var(--border);color:var(--text)">Cancel</button>
    </div>
</div></div>

<div id="modal-rt" class="modal-overlay"><div class="modal">
    <button class="close" onclick="window.closeModal('rt')">×</button>
    <h2>Add / Edit Resource Type</h2>
    <input id="rt-id" type="hidden">
    <input id="rt-name" placeholder="Name" style="width:100%;margin-top:12px">
    <textarea id="rt-desc" placeholder="Description" style="width:100%;margin-top:12px"></textarea>
    <div style="text-align:right;margin-top:16px"><button onclick="window.saveResourceType()">Save</button><button onclick="window.closeModal('rt')" style="background:var(--border);color:var(--text)">Cancel</button></div>
</div></div>

<div id="modal-ef" class="modal-overlay"><div class="modal">
    <button class="close" onclick="window.closeModal('ef')">×</button>
    <h2>Add / Edit Estimation Factor</h2>
    <input id="ef-id" type="hidden">
    
    <div class="modal-content-flex">
        <div class="initiative-details-left"> <!-- Reusing class for layout -->
            <input id="ef-name" placeholder="Name" style="width:100%;margin-top:12px">
            <textarea id="ef-description" placeholder="Description" style="width:100%;margin-top:12px"></textarea> <!-- New description field -->
            <div id="ef-hours" style="margin-top:12px"></div>
        </div>
        <div class="initiative-journal-right"> <!-- Reusing class for layout -->
            <div class="flex" style="margin-bottom:12px;">
                <div style="flex:1;"><label><b>Created</b></label><br><span id="ef-created"></span></div>
                <div style="flex:1;"><label><b>Updated</b></label><br><span id="ef-updated"></span></div>
            </div>
            <h3>Journal</h3>
            <div id="ef-journal-log" style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border); padding: 10px; border-radius: 6px; background: #f9fafb; flex-grow: 1;"></div>
            <textarea id="ef-journal-comment-input" placeholder="Add a new comment..." style="width:100%; margin-top:10px; min-height: 60px;"></textarea>
            <button onclick="window.addJournalCommentEF()" style="margin-top:8px;">Add Comment</button>
        </div>
    </div>

    <div class="flex" style="justify-content:flex-end;margin-top:16px">
        <button class="dup-button" onclick="window.duplicateEstimationFactor()">Dup</button> <!-- New Dup button -->
        <button onclick="window.saveEstimationFactor()">Save</button>
        <button onclick="window.closeModal('ef')" style="background:var(--border);color:var(--text)">Cancel</button>
    </div>
</div></div>

<div id="modal-factors" class="modal-overlay"><div class="modal">
    <button class="close" onclick="window.closeModal('factors')">×</button>
    <div class="factor-calc">
      <div id="factor-hours">0h</div>
      <div id="factor-days">0d</div>
      <div id="factor-months">0m</div>
      <div id="factor-size">Size: XS</div>
    </div>
    <h2 style="padding-right: 120px;">T-Shirt Factors</h2>
    <!-- New search input -->
    <input type="text" id="factor-search-input" placeholder="Search factors..." oninput="window.loadFactorPicker(this.value)">
    <div id="factor-picker-container"> <!-- New container for scrollbar -->
        <div id="factor-picker"></div>
    </div>
    <div style="text-align:right;margin-top:16px"><button onclick="window.saveFactors()">Save</button><button onclick="window.closeModal('factors')" style="background:var(--border);color:var(--text)">Cancel</button></div>
</div></div>

<div id="modal-audit" class="modal-overlay"><div class="modal">
    <button class="close" onclick="window.closeModal('audit')">×</button>
    <h2 id="audit-title">Audit Trail</h2>
    <div id="audit-content" class="audit-container"></div>
</div></div>

<div id="modal-shirt-size-audit" class="modal-overlay"><div class="modal">
    <button class="close" onclick="window.closeModal('shirt-size-audit')">×</button>
    <h2 id="shirt-size-audit-title">Shirt Size Audit Trail</h2>
    <div id="shirt-size-audit-content" class="audit-container"></div>
</div></div>

<!-- New modal for Estimation Factor Audit -->
<div id="modal-ef-audit" class="message-box-overlay"> <!-- Reusing overlay class for simplicity -->
    <div class="modal">
        <button class="close" onclick="window.closeModal('ef-audit')">×</button>
        <h2 id="ef-audit-title">Estimation Factor Audit Trail</h2>
        <div id="ef-audit-content" class="audit-container"></div>
    </div>
</div>


<!-- Custom Message Box Modal -->
<div id="messageBoxModal" class="message-box-overlay">
    <div class="message-box">
        <h3 id="messageBoxTitle"></h3>
        <p id="messageBoxContent"></p>
        <button onclick="window.hideMessage()">OK</button>
    </div>
</div>

<footer>
    Build R20250804161100
</footer>

<script>
const API = '';
window.selectedFactors = [];
window.efList = [];
window.rtList = [];
window.shirtSizes = [];
window.currentInitiativeJournal = []; // Global variable to hold journal entries for the current initiative
window.currentEstimationFactorJournal = []; // New: Global variable for estimation factor journal

// Global state for initiatives sorting
let currentSortColumn = 'created_at';
let currentSortDirection = 'desc';

// User preferences for display limits, loaded from cookie
window.userPreferences = {
    maxInitiatives: 8,
    maxResourceTypes: 5,
    maxEstimationFactors: 5
};

// Helper function to format date/time in EST
function formatDateInEST(isoString, includeTime = true) {
    if (!isoString) return '';
    const date = new Date(isoString);
    const options = {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        timeZone: 'America/New_York'
    };
    let datePart = date.toLocaleString('en-US', options); // e.g., "08/04/2025"

    if (includeTime) {
        const timeOptions = {
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: true,
            timeZone: 'America/New_York'
        };
        let timePart = date.toLocaleString('en-US', timeOptions); // e.g., "05:47:00 PM"
        // Remove the comma if it appears after the date part in some locales
        return `${datePart.replace(/,/g, '')} ${timePart.replace(/,/g, '')}`;
    }
    return datePart.replace(/,/g, '');
}

// Custom Message Box Functions
function showMessage(title, message, type = 'info') {
    const modal = document.getElementById('messageBoxModal');
    const titleElement = document.getElementById('messageBoxTitle');
    const contentElement = document.getElementById('messageBoxContent');
    const messageBox = modal.querySelector('.message-box');

    titleElement.textContent = title;
    contentElement.textContent = message;

    // Remove previous type classes and add the new one
    messageBox.classList.remove('success', 'error');
    if (type === 'success') {
        messageBox.classList.add('success');
    } else if (type === 'error') {
        messageBox.classList.add('error');
    }

    modal.style.display = 'flex';
}

function hideMessage() {
    document.getElementById('messageBoxModal').style.display = 'none';
}


// Define functions at the global scope
function renderSelectedFactorsSummary() {
    const summary = document.getElementById('selected-factors-summary');
    if (summary) {
        if (window.selectedFactors && window.selectedFactors.length > 0) {
            summary.innerHTML = `<p>${window.selectedFactors.length} factor(s) selected.</p>`;
        } else {
            summary.innerHTML = `<p>No factors selected.</p>`;
        }
    } else {
        console.warn("Element 'selected-factors-summary' not found.");
    }
}

function openModal(type) {
  document.getElementById('modal-' + type).style.display = 'flex';
}
function closeModal(type) {
  document.getElementById('modal-' + type).style.display = 'none';
}

// Function to toggle the flyout menu visibility
function toggleFlyoutMenu() {
    const flyoutMenu = document.getElementById('flyout-menu');
    flyoutMenu.classList.toggle('active');
}
window.toggleFlyoutMenu = toggleFlyoutMenu; // Make it globally accessible


function show(hash) {
  document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
  const id = (hash || '#home').slice(1);
  const sec = document.getElementById(id);
  if (sec) {
      sec.classList.add('active');
      // Scroll to the section with an offset for the fixed header
      const headerHeight = document.getElementById('main-header').offsetHeight;
      // Using setTimeout with a small delay to ensure rendering is complete before scrolling
      setTimeout(() => {
          window.scrollTo({
              top: sec.offsetTop - headerHeight,
              behavior: 'smooth'
          });
      }, 50); // Small delay to allow layout to settle
  }

  if (id === 'home') loadInitiatives(currentSortColumn, currentSortDirection); // Pass sort state
  if (id === 'factors') {
    loadRT().then(loadEF);
  }
  if (id === 'shirt-sizes') loadShirtSizes();
  if (id === 'prefs') populatePrefsPage(); // Populate prefs fields when page is shown
  
  // Close the flyout menu if it's open
  const flyoutMenu = document.getElementById('flyout-menu');
  if (flyoutMenu.classList.contains('active')) {
      flyoutMenu.classList.remove('active');
  }
}
window.show = show; // Make it globally accessible

window.addEventListener('hashchange', () => show(location.hash));

// Resource Types CRUD
async function loadRT() {
  const res = await fetch(API + '/api/resource-types');
  const allResourceTypes = await res.json();
  window.rtList = allResourceTypes; // Store all resource types

  const searchQuery = document.getElementById('rt-search-input')?.value.toLowerCase() || '';

  // Filter resource types based on search query
  let filteredResourceTypes = allResourceTypes.filter(r => {
    return r.name.toLowerCase().includes(searchQuery) || (r.description && r.description.toLowerCase().includes(searchQuery));
  });

  // Sort filtered resource types alphabetically by name
  filteredResourceTypes.sort((a, b) => a.name.localeCompare(b.name));

  const tbody = document.querySelector('#rt-table tbody');
  tbody.innerHTML = '';

  // Limit the number of displayed items
  const displayLimit = window.userPreferences.maxResourceTypes;
  const itemsToDisplay = filteredResourceTypes.slice(0, displayLimit);

  itemsToDisplay.forEach(r => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.name}</td><td>${r.description||''}</td><td><button onclick="window.editRT('${r.id}')">Edit</button><button onclick=\"window.delRT('${r.id}')\" style=\"background:var(--red)\">Del</button></td>`;
    tbody.appendChild(tr);
  });

  // Dynamically adjust table container height if needed (though fixed is set in CSS)
  const rtTableContainer = document.getElementById('rt-table-container');
  if (rtTableContainer) {
      // Calculate approximate row height (e.g., 45px per row including padding/border)
      // This is a fallback if CSS max-height isn't perfectly aligned with row count
      // For simplicity and consistency with fixed CSS, we'll rely on the CSS max-height.
      // If dynamic height based on actual content is strictly needed, this is where it would go.
  }
}
// New function to clear and open Resource Type modal for adding
function openAddResourceTypeModal() {
    document.getElementById('rt-id').value = '';
    document.getElementById('rt-name').value = '';
    document.getElementById('rt-desc').value = '';
    openModal('rt');
}
function editRT(id) {
  const rt = window.rtList.find(x => x.id === id);
  document.getElementById('rt-id').value = rt.id;
  document.getElementById('rt-name').value = rt.name;
  document.getElementById('rt-desc').value = rt.description || '';
  openModal('rt');
}
async function delRT(id) {
  if (!confirm('Delete?')) return; 
  await fetch(API + `/api/resource-types/${id}`, { method: 'DELETE' });
  loadRT();
}
async function saveResourceType() {
  const id = document.getElementById('rt-id').value.trim();
  const name = document.getElementById('rt-name').value.trim();
  if (!name) { showMessage('Error', 'Name required', 'error'); return; }
  const desc = document.getElementById('rt-desc').value;
  const url = id ? `/api/resource-types/${id}` : '/api/resource-types';
  const method = id ? 'PUT' : 'POST';
  const res = await fetch(API + url, {
    method, headers: {'Content-Type':'application/json'},
    body: JSON.stringify({ name, description: desc })
  });
  if (!res.ok) { showMessage('Error', 'Error: ' + res.status, 'error'); return; }
  closeModal('rt'); loadRT();
}

// Estimation Factors CRUD
function renderEFGrid() {
  const cont = document.getElementById('ef-hours'); cont.innerHTML = '';
  (window.rtList||[]).forEach(rt => {
    const row = document.createElement('div'); row.className = 'flex';
    row.innerHTML = `<label style=\"width:120px\">${rt.name}</label><input type=\"number\" min=\"0\" id=\"ef-h-${rt.id}\"><select id=\"ef-u-${rt.id}\"><option value=\"h\">h</option><option value=\"d\">d</option></select>`;
    cont.appendChild(row);
  });
}
async function loadEF() {
  renderEFGrid(); // This is for the modal, keep it.
  const res = await fetch(API + '/api/estimation-factors');
  const allFactors = await res.json();
  window.efList = allFactors; // Store all factors

  const searchQuery = document.getElementById('ef-search-input')?.value.toLowerCase() || '';

  // Filter factors based on search query
  let filteredFactors = allFactors.filter(f => {
    const factorName = f.name.toLowerCase();
    const factorDescription = (f.description || '').toLowerCase(); // Include description in search
    const resourceNames = Object.entries(f.hoursPerResourceType || {})
      .map(([id]) => {
        const r = window.rtList.find(x => x.id === id);
        return r ? r.name.toLowerCase() : '';
      })
      .join(' ');
    return factorName.includes(searchQuery) || factorDescription.includes(searchQuery) || resourceNames.includes(searchQuery);
  });

  // Sort filtered factors alphabetically by name
  filteredFactors.sort((a, b) => a.name.localeCompare(b.name));

  const tbody = document.querySelector('#ef-table tbody');
  tbody.innerHTML = '';

  // Limit the number of displayed items
  const displayLimit = window.userPreferences.maxEstimationFactors;
  const itemsToDisplay = filteredFactors.slice(0, displayLimit);

  itemsToDisplay.forEach(f => {
    const hrs = f.hoursPerResourceType || {};
    const names = Object.entries(hrs).filter(([,v])=>v>0).map(([id])=>{ const r=window.rtList.find(x=>x.id===id); return r?r.name:id; }).join(',');
    const total = Object.values(hrs).reduce((a,b)=>a+b,0), days = (total/8).toFixed(1);
    const createdDate = formatDateInEST(f.created_at, true);
    const updatedDate = formatDateInEST(f.updated_at, true);
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${f.name}</td><td>${names}</td><td>${days}</td><td>${total}</td><td style="white-space:nowrap;"><button onclick=\"window.editEF('${f.id}')\">Edit</button><button onclick=\"window.delEF('${f.id}')\" style=\"background:var(--red)\">Del</button><button onclick="window.showAuditTrailEF('${f.id}', '${f.name}')">🔍</button></td>`;
    tbody.appendChild(tr);
  });
}
async function addEstimationFactor() { // Made async to await loadRT()
  await loadRT(); // Ensure resource types are loaded before rendering the grid
  document.getElementById('ef-id').value = ''; // Clear ID for new entry
  document.getElementById('ef-name').value = '';
  document.getElementById('ef-description').value = ''; // Clear description
  // Clear all resource hour inputs
  (window.rtList||[]).forEach(rt => {
      const inp = document.getElementById(`ef-h-${rt.id}`);
      if (inp) inp.value = '';
      const sel = document.getElementById(`ef-u-${rt.id}`);
      if (sel) sel.value = 'h'; // Reset to hours
  });
  document.getElementById('ef-created').textContent = ''; // Clear created_at
  document.getElementById('ef-updated').textContent = ''; // Clear updated_at
  window.currentEstimationFactorJournal = []; // Clear journal for new factor
  renderJournalLogEF(); // Render empty journal
  document.getElementById('ef-journal-comment-input').value = ''; // Clear comment input
  renderEFGrid(); // Re-render the grid after ensuring rtList is populated
  openModal('ef');
}
async function editEF(id) { // Made async to fetch full factor data
  await loadRT(); // Ensure resource types are loaded for renderEFGrid
  const f = window.efList.find(x=>x.id===id);
  if (!f) { showMessage('Error', 'Estimation Factor not found.', 'error'); return; } // Added error handling

  document.getElementById('ef-id').value=id; 
  document.getElementById('ef-name').value=f.name;
  document.getElementById('ef-description').value = f.description || ''; // Populate description
  
  renderEFGrid(); 
  let hrs=f.hoursPerResourceType||{};
  Object.entries(hrs).forEach(([rtId,val])=>{
    const inp=document.getElementById(`ef-h-${rtId}`), sel=document.getElementById(`ef-u-${rtId}`);
    if(inp){ if(val%8===0){inp.value=val/8; sel.value='d';} else{inp.value=val; sel.value='h';} }
  }); 

  document.getElementById('ef-created').textContent = formatDateInEST(f.created_at);
  document.getElementById('ef-updated').textContent = formatDateInEST(f.updated_at);
  window.currentEstimationFactorJournal = f.journal_entries || []; // Load journal
  renderJournalLogEF(); // Render the loaded journal entries
  document.getElementById('ef-journal-comment-input').value = ''; // Clear comment input
  openModal('ef');
}
async function delEF(id) { 
  if(!confirm('Delete?')) return; 
  await fetch(API+`/api/estimation-factors/${id}`,{method:'DELETE'}); loadEF(); 
}
async function saveEstimationFactor() {
  const id=document.getElementById('ef-id').value.trim(), name=document.getElementById('ef-name').value.trim(); if(!name){showMessage('Error', 'Name required', 'error');return;}
  const description = document.getElementById('ef-description').value.trim(); // Get description
  const hours={}; (window.rtList||[]).forEach(rt=>{ const inp=document.getElementById(`ef-h-${rt.id}`), sel=document.getElementById(`ef-u-${rt.id}`); if(!inp)return;let val=+inp.value; if(val<=0)return; if(sel.value==='d') val*=8; hours[rt.id]=val; });
  
  const payload = {
      name,
      description, // Add description to payload
      hoursPerResourceType: hours,
      journal_entries: window.currentEstimationFactorJournal // Send journal entries
  };

  const url=id?`/api/estimation-factors/${id}`:'/api/estimation-factors', method=id?'PUT':'POST';
  const res=await fetch(API+url,{method,headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
  if(!res.ok){showMessage('Error', 'Error:'+res.status, 'error');return;} closeModal('ef'); loadEF();
}

// Factors Modal and T-Shirt Sizing
async function loadFactorPicker(searchQuery = ''){
  const area=document.getElementById('factor-picker'); area.innerHTML='';
  
  // Filter and sort window.efList
  const lowerCaseSearchQuery = searchQuery.toLowerCase();
  
  // First, map the factors to include their checked status for sorting
  const factorsWithCheckedStatus = window.efList.map(f => {
      const isChecked = window.selectedFactors.some(sf => sf.factorId === f.id);
      return { ...f, isChecked: isChecked };
  });

  const filteredAndSortedEfList = factorsWithCheckedStatus
    .filter(f => {
      const factorName = f.name.toLowerCase();
      const factorDescription = (f.description || '').toLowerCase(); // Include description in search
      const resourceNames = Object.entries(f.hoursPerResourceType || {})
        .map(([id]) => {
          const r = window.rtList.find(x => x.id === id);
          return r ? r.name.toLowerCase() : '';
        })
        .join(' ');
      return factorName.includes(lowerCaseSearchQuery) || factorDescription.includes(lowerCaseSearchQuery) || resourceNames.includes(lowerCaseSearchQuery);
    })
    .sort((a, b) => {
        // Primary sort: checked status (true first)
        if (a.isChecked && !b.isChecked) return -1;
        if (!a.isChecked && b.isChecked) return 1;
        // Secondary sort: alphabetical by name
        return a.name.localeCompare(b.name);
    });

  filteredAndSortedEfList.forEach(f=>{
    const row=document.createElement('div');
    row.className='factor-item'; // Apply new class for alignment

    const checked = f.isChecked ? 'checked' : '';
    const qty = window.selectedFactors.find(sf => sf.factorId === f.id)?.quantity || '1';
    const qtyDisplay = f.isChecked ? 'inline-block' : 'none'; // Initial display state

    // Generate resource details string
    let resourceDetails = '';
    const hrs = f.hoursPerResourceType || {};
    const resourceParts = Object.entries(hrs)
        .filter(([, v]) => v > 0)
        .map(([id, val]) => {
            const r = window.rtList.find(x => x.id === id);
            return r ? `${r.name}: ${val}h` : `${id}: ${val}h`;
        });
    if (resourceParts.length > 0) {
        resourceDetails = `(${resourceParts.join(', ')})`;
    }


    // Use a custom checkbox structure
    row.innerHTML = `
        <label class="custom-checkbox">
            <input type="checkbox" data-id="${f.id}" onchange="window.toggleQty('${f.id}');" ${checked}>
            <span class="checkmark"></span>
        </label>
        <div class="factor-item-content">
            <div class="factor-name">${f.name}</div>
            <div class="factor-resources">${resourceDetails}</div>
        </div>
        <input type="number" id="qty-${f.id}" value="${qty}" min="1" oninput="window.updateFactorCalculations()" style="display:${qtyDisplay}">
    `;
    area.appendChild(row);
  });
  updateFactorCalculations();
  // Ensure initial state of quantity inputs is correctly set for transition
  filteredAndSortedEfList.forEach(f => { // Iterate over sorted list
      toggleQtyDisplay(f.id); // Call toggleQtyDisplay for each to set initial display/opacity
  });
}

// Renamed from toggleQty to toggleQtyDisplay to clarify its purpose
function toggleQtyDisplay(id){
    const cb = document.querySelector(`#factor-picker input[data-id='${id}']`);
    const qtyInput = document.getElementById(`qty-${id}`);
    if (cb && qtyInput) {
        if (cb.checked) {
            qtyInput.style.display = 'inline-block';
            qtyInput.style.opacity = '1';
            qtyInput.style.width = '70px'; // Restore width
            qtyInput.style.paddingLeft = '8px'; // Restore padding
            qtyInput.style.paddingRight = '10px';
            qtyInput.style.border = '1px solid var(--border)'; // Restore border
        } else {
            qtyInput.style.opacity = '0';
            qtyInput.style.width = '0'; // Collapse width
            qtyInput.style.paddingLeft = '0';
            qtyInput.style.right = '0';
            qtyInput.style.border = 'none'; // Hide border
            // Use a timeout to set display: none after transition completes
            setTimeout(() => {
                qtyInput.style.display = 'none';
            }, 300); // Match CSS transition duration
        }
    }
}

// New function to handle checkbox change and re-render the list
function toggleQty(id) {
    const cb = document.querySelector(`#factor-picker input[data-id='${id}']`);
    const qtyInput = document.getElementById(`qty-${id}`);

    if (cb.checked) {
        // If checked, add to selectedFactors
        const factor = window.efList.find(f => f.id === id);
        if (factor && !window.selectedFactors.some(sf => sf.factorId === id)) {
            window.selectedFactors.push({
                factorId: factor.id,
                quantity: +qtyInput.value || 1,
                name: factor.name,
                hoursPerResourceType: factor.hoursPerResourceType
            });
        }
    } else {
        // If unchecked, remove from selectedFactors
        window.selectedFactors = window.selectedFactors.filter(sf => sf.factorId !== id);
    }
    
    // Re-render the factor picker to apply the new sorting and display states
    const currentSearchQuery = document.getElementById('factor-search-input').value;
    loadFactorPicker(currentSearchQuery);
    updateFactorCalculations(); // Update calculations immediately
}


async function openFactorModal() {
    await loadRT();
    await loadEF();
    await loadShirtSizes(); // Load shirt sizes as well
    document.getElementById('factor-search-input').value = ''; // Clear search input on open
    loadFactorPicker(); // Load all factors initially
    openModal('factors');
}
function saveFactors() {
    // selectedFactors is already maintained by toggleQty, so no need to rebuild it here
    renderSelectedFactorsSummary();

    // Recalculate total hours and shirt size for display in the main initiative modal
    let totalHoursForDisplay = 0;
    window.selectedFactors.forEach(f => {
        const totalFactorHours = Object.values(f.hoursPerResourceType || {}).reduce((sum, h) => sum + h, 0);
        totalHoursForDisplay += totalFactorHours * (f.quantity || 1);
    });
    const shirtSizeForDisplay = getShirtSizeFromHours(totalHoursForDisplay);

    // Update the displayed shirt size and hours in the main initiative modal
    document.getElementById('init-calculated-shirt-size').textContent = `Calculated T-Shirt Size: ${shirtSizeForDisplay} (${totalHoursForDisplay}h)`;

    // Close the factors modal
    closeModal('factors');
}
function getShirtSizeFromHours(hours) {
    let size = 'XS';
    // Sort shirt sizes by threshold_hours in ascending order to find the correct size
    const sortedSizes = [...window.shirtSizes].sort((a, b) => a.threshold_hours - b.threshold_hours);
    for (const s of sortedSizes) {
        if (hours >= s.threshold_hours) {
            size = s.size;
        } else {
            // If current hours are less than the threshold, the previous size was the correct one.
            // This break ensures we pick the smallest size that.
            break; 
        }
    }
    return size;
}
function updateFactorCalculations() {
    let totalHours = 0;
    // Iterate over all factors in window.efList (not just filtered ones)
    (window.efList||[]).forEach(f => {
        const cb = document.querySelector(`#factor-picker input[data-id='${f.id}']`);
        // Only include if the checkbox exists (meaning it was rendered) and is checked
        if (cb && cb.checked) {
            const qty = +document.getElementById(`qty-${f.id}`).value || 0;
            const totalFactorHours = Object.values(f.hoursPerResourceType || {}).reduce((sum, h) => sum + h, 0);
            totalHours += totalFactorHours * qty;
        }
    });
    // Assuming 8 hours per day, 160 hours per person month
    const hoursPerDay = 8;
    const hoursPerMonth = 160; 

    const totalDays = (totalHours / hoursPerDay).toFixed(1);
    const totalMonths = (totalHours / hoursPerMonth).toFixed(1);
    const shirtSize = getShirtSizeFromHours(totalHours);

    document.getElementById('factor-hours').textContent = `${totalHours}h`;
    document.getElementById('factor-days').textContent = `${totalDays}d`;
    document.getElementById('factor-months').textContent = `${totalMonths}m`;
    document.getElementById('factor-size').textContent = `Size: ${shirtSize}`;
}

// Journal functions for Initiatives
function renderJournalLog() {
    const journalLogDiv = document.getElementById('initiative-journal-log');
    journalLogDiv.innerHTML = ''; // Clear existing entries
    if (window.currentInitiativeJournal && window.currentInitiativeJournal.length > 0) {
        // Sort entries by timestamp in ASCENDING order (oldest first)
        const sortedJournal = [...window.currentInitiativeJournal].sort((a, b) => new Date(a.timestamp).getTime() - new Date(b.timestamp).getTime());
        sortedJournal.forEach(entry => {
            const entryDiv = document.createElement('div');
            entryDiv.className = 'journal-entry';
            const formattedDate = formatDateInEST(entry.timestamp); // Use helper for journal

            if (entry.type === 'audit') {
                entryDiv.classList.add('audit');
                let details = '';
                // Ensure oldData and newData are objects, even if they were empty strings or null
                const oldData = typeof entry.old_data === 'object' && entry.old_data !== null ? entry.old_data : {};
                const newData = typeof entry.new_data === 'object' && entry.new_data !== null ? entry.new_data : {};

                if (entry.action === 'created') {
                    details = `Created with estimated hours: ${newData.computed_hours} and size: ${newData.shirt_size}.`;
                } else if (entry.action === 'updated') {
                    // CRITICAL FIX: Ensure selected_factors are parsed into arrays
                    const oldFactors = JSON.parse(oldData.selected_factors || '[]');
                    const newFactors = JSON.parse(newData.selected_factors || '[]');

                    const diffs = [];
                    const keysToCompare = [
                        'name', 'custom_id', 'description', 'priority', 'priority_num',
                        'status', 'classification', 'scope', 'out_of_scope',
                        'computed_hours', 'shirt_size', 'start_date', 'end_date'
                    ];

                    for (const key of keysToCompare) {
                        const oldValue = oldData[key];
                        const newValue = newData[key];
                        
                        // Special handling for date fields to compare only YYYY-MM-DD part
                        if (key === 'start_date' || key === 'end_date') {
                            const oldDate = (oldValue || '').substring(0, 10);
                            const newDate = (newValue || '').substring(0, 10);
                            if (oldDate !== newDate) {
                                diffs.push(`- Changed ${key} from <span class="diff-removed">${oldDate}</span> to <span class="diff-added">${newDate}</span>`);
                            }
                        } else {
                            if (oldValue !== newValue) {
                                diffs.push(`- Changed ${key} from <span class="diff-removed">${oldValue}</span> to <span class="diff-added">${newValue}</span>`);
                            }
                        }
                    }

                    // Compare selected_factors separately
                    // Sort factors before stringifying for consistent comparison
                    // CRITICAL FIX: Ensure factorId is handled safely for localeCompare
                    const oldFactorsStr = JSON.stringify([...oldFactors].sort((a, b) => (a?.factorId || '').localeCompare(b?.factorId || '')));
                    const newFactorsStr = JSON.stringify([...newFactors].sort((a, b) => (a?.factorId || '').localeCompare(b?.factorId || '')));

                    if (oldFactorsStr !== newFactorsStr) {
                        // Detailed factor changes
                        newFactors.forEach(newFactor => {
                            const oldFactor = oldFactors.find(of => of.factorId === newFactor.factorId);
                            if (!oldFactor) {
                                diffs.push(`- <span class="diff-added">Added factor: ${newFactor.name} (Qty: ${newFactor.quantity})</span>`);
                            } else if (oldFactor.quantity !== newFactor.quantity) {
                                diffs.push(`- Changed quantity for factor ${newFactor.name} from <span class="diff-removed">${oldFactor.quantity}</span> to <span class="diff-added">${newFactor.quantity}</span>.`);
                            }
                        });

                        oldFactors.forEach(oldFactor => {
                            const newFactor = newFactors.find(nf => nf.factorId === oldFactor.factorId);
                            if (!newFactor) {
                                diffs.push(`- <span class="diff-removed">Removed factor: ${oldFactor.name} (Qty: ${oldFactor.quantity})</span>`);
                            }
                        });
                    }
                    details = diffs.length > 0 ? diffs.join('<br>') : 'No changes to tracked fields.';
                } else if (entry.action === 'duplicated_from') { // New audit type
                    details = `Duplicated from: ${entry.original_name}.`;
                }
                entryDiv.innerHTML = `<span class="timestamp">${formattedDate}</span><h4>${entry.action.charAt(0).toUpperCase() + entry.action.slice(1).replace(/_/g, ' ')}</h4><p>${details}</p>`;
            } else { // type === 'comment'
                entryDiv.innerHTML = `<span class="timestamp">${formattedDate}</span>${entry.text}`;
            }
            journalLogDiv.appendChild(entryDiv);
        });
        // Scroll to the bottom to show the latest entry, with a slight delay
        setTimeout(() => {
            journalLogDiv.scrollTop = journalLogDiv.scrollHeight;
        }, 50); // Small delay to ensure rendering is complete
    } else {
        journalLogDiv.innerHTML = '<p style="text-align: center; color: #888;">No journal entries yet.</p>';
    }
}

async function saveJournalEntryToBackend(initiativeId, journalEntries) {
    if (!initiativeId) {
        console.warn("Cannot save journal entry: Initiative ID is missing. Please save the initiative first.");
        return;
    }
    
    try {
        // Fetch the current initiative to get all its fields
        const res = await fetch(API + `/api/initiatives/${initiativeId}`);
        if (!res.ok) { throw new Error('Failed to fetch initiative for journal update.'); }
        const currentInitiative = await res.json();

        // Update only the journal_entries and updated_at fields
        currentInitiative.journal_entries = journalEntries;
        currentInitiative.updated_at = new Date().toISOString(); // Update timestamp

        // Send the full updated object back to the backend
        const updateRes = await fetch(API + `/api/initiatives/${initiativeId}`, {
            method: 'PUT',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(currentInitiative)
        });

        if (!updateRes.ok) {
            console.error('Error saving journal entry:', updateRes.status, await updateRes.text());
        } else {
            console.log('Journal entry saved to backend successfully.');
            // Reload initiatives to reflect updated_at and potentially other changes
            loadInitiatives(currentSortColumn, currentSortDirection);
        }
    } catch (error) {
        console.error('Error in saveJournalEntryToBackend:', error);
    }
}

function addJournalComment() {
    const commentInput = document.getElementById('journal-comment-input');
    const commentText = commentInput.value.trim();
    const initiativeId = document.getElementById('init-id').value; // Get current initiative ID

    if (!commentText) {
        // Do nothing if comment is empty
        return;
    }

    if (!initiativeId) {
        showMessage('Error', "Please save the initiative first before adding journal comments.", 'error');
        return;
    }

    const newEntry = {
        timestamp: new Date().toISOString(),
        type: 'comment', // Explicitly mark as a comment
        text: commentText
    };
    window.currentInitiativeJournal.push(newEntry);
    renderJournalLog(); // Re-render to show the new comment
    commentInput.value = ''; // Clear the input field

    // Trigger an asynchronous save to the backend
    saveJournalEntryToBackend(initiativeId, window.currentInitiativeJournal);
}


// Journal functions for Estimation Factors (New)
function renderJournalLogEF() {
    const journalLogDiv = document.getElementById('ef-journal-log');
    journalLogDiv.innerHTML = ''; // Clear existing entries
    if (window.currentEstimationFactorJournal && window.currentEstimationFactorJournal.length > 0) {
        // Sort entries by timestamp in ASCENDING order (oldest first)
        const sortedJournal = [...window.currentEstimationFactorJournal].sort((a, b) => new Date(a.timestamp).getTime() - new Date(b.timestamp).getTime());
        sortedJournal.forEach(entry => {
            const entryDiv = document.createElement('div');
            entryDiv.className = 'journal-entry';
            const formattedDate = formatDateInEST(entry.timestamp);

            if (entry.type === 'audit') {
                entryDiv.classList.add('audit');
                let details = '';
                // Ensure oldData and newData are objects, even if they were empty strings or null
                const oldData = typeof entry.old_data === 'object' && entry.old_data !== null ? entry.old_data : {};
                const newData = typeof entry.new_data === 'object' && entry.new_data !== null ? entry.new_data : {};

                // console.log('DEBUG: EF Audit Entry - Action:', entry.action); // Debugging
                // console.log('DEBUG: EF Audit Entry - Old Data:', oldData); // Debugging
                // console.log('DEBUG: EF Audit Entry - New Data:', newData); // Debugging
                // console.log('DEBUG: EF Audit Entry - New Data Name:', newData.name); // Debugging

                if (entry.action === 'created') {
                    details = `Created factor: ${newData.name ? newData.name : 'N/A'}.`; // Robust check for name
                } else if (entry.action === 'updated') {
                    const diffs = [];
                    // Compare name
                    if (oldData.name !== newData.name) {
                        diffs.push(`- Changed name from <span class="diff-removed">${oldData.name || '""'}</span> to <span class="diff-added">${newData.name || '""'}</span>`);
                    }
                    // Compare description
                    if (oldData.description !== newData.description) {
                        diffs.push(`- Changed description from <span class="diff-removed">${oldData.description || '""'}</span> to <span class="diff-added">${newData.description || '""'}</span>`);
                    }

                    // Compare hoursPerResourceType
                    const oldHours = oldData.hoursPerResourceType || {};
                    const newHours = newData.hoursPerResourceType || {};

                    const allResourceIds = new Set([...Object.keys(oldHours), ...Object.keys(newHours)]);
                    allResourceIds.forEach(resId => {
                        const oldVal = oldHours[resId] || 0;
                        const newVal = newHours[resId] || 0;
                        const resourceName = window.rtList.find(r => r.id === resId)?.name || resId; // Get resource name

                        if (oldVal === 0 && newVal > 0) {
                            diffs.push(`- <span class="diff-added">Added resource ${resourceName} with ${newVal}h</span>`);
                        } else if (oldVal > 0 && newVal === 0) {
                            diffs.push(`- <span class="diff-removed">Removed resource ${resourceName} (was ${oldVal}h)</span>`);
                        } else if (oldVal !== newVal) {
                            diffs.push(`- Changed hours for ${resourceName} from <span class="diff-removed">${oldVal}h</span> to <span class="diff-added">${newVal}h</span>`);
                        }
                    });
                    details = diffs.length > 0 ? diffs.join('<br>') : 'No changes to tracked fields.';
                } else if (entry.action === 'duplicated_from') { // New audit type
                    details = `Duplicated from: ${entry.original_name}.`;
                }
                entryDiv.innerHTML = `<span class="timestamp">${formattedDate}</span><h4>${entry.action.charAt(0).toUpperCase() + entry.action.slice(1).replace(/_/g, ' ')}</h4><p>${details}</p>`;
            } else { // type === 'comment'
                entryDiv.innerHTML = `<span class="timestamp">${formattedDate}</span>${entry.text}`;
            }
            journalLogDiv.appendChild(entryDiv);
        });
        setTimeout(() => {
            journalLogDiv.scrollTop = journalLogDiv.scrollHeight;
        }, 50);
    } else {
        journalLogDiv.innerHTML = '<p style="text-align: center; color: #888;">No journal entries yet.</p>';
    }
}

// Removed saveJournalEntryToBackendEF function.
// Journal entries are now saved as part of the main saveEstimationFactor call.

function addJournalCommentEF() {
    const commentInput = document.getElementById('ef-journal-comment-input');
    const commentText = commentInput.value.trim();
    // No factorId check needed here, as saving is handled by main Save button
    // No API call here, just update local state

    if (!commentText) {
        return;
    }

    const newEntry = {
        timestamp: new Date().toISOString(),
        type: 'comment',
        text: commentText
    };
    window.currentEstimationFactorJournal.push(newEntry);
    renderJournalLogEF();
    commentInput.value = '';

    // The actual saving to backend will happen when saveEstimationFactor() is called.
}


// Initiatives CRUD
async function loadInitiatives(sortBy = 'created_at', sortDirection = 'desc') {
  const res = await fetch(API + '/api/initiatives');
  let allInitiatives = await res.json();
  window.initList = allInitiatives; // Store all initiatives

  const searchQuery = document.getElementById('init-search-input')?.value.toLowerCase() || '';

  // Filter initiatives based on search query
  let filteredInitiatives = allInitiatives.filter(i => {
    return i.name.toLowerCase().includes(searchQuery) || 
           (i.custom_id && i.custom_id.toLowerCase().includes(searchQuery)) ||
           (i.description && i.description.toLowerCase().includes(searchQuery));
  });

  // Sort the filtered list based on sortBy and sortDirection
  filteredInitiatives.sort((a, b) => {
    let valA = a[sortBy];
    let valB = b[sortBy];

    // Handle numeric sorting
    if (sortBy === 'id' || sortBy === 'computed_hours' || sortBy === 'priority_num') {
        valA = parseFloat(valA);
        valB = parseFloat(valB);
    } 
    // Handle date sorting (ISO strings can be compared directly)
    else if (sortBy.includes('_date') || sortBy.includes('_at')) {
        valA = valA ? new Date(valA).getTime() : 0; // Treat null/empty dates as 0 for sorting
        valB = valB ? new Date(valB).getTime() : 0;
    }
    // Default to string comparison for others
    else {
        valA = String(valA || '').toLowerCase();
        valB = String(valB || '').toLowerCase();
    }

    if (valA < valB) {
      return sortDirection === 'asc' ? -1 : 1;
    }
    if (valA > valB) {
      return sortDirection === 'asc' ? 1 : -1;
    }
    return 0;
  });

  const tbody = document.querySelector('#init-table tbody');
  tbody.innerHTML = '';

  // Limit the number of displayed items
  const displayLimit = window.userPreferences.maxInitiatives;
  const itemsToDisplay = filteredInitiatives.slice(0, displayLimit);

  itemsToDisplay.forEach(i => {
    const createdDate = formatDateInEST(i.created_at, true); // Format in EST with time
    const updatedDate = formatDateInEST(i.updated_at, true); // Format in EST with time
    const startDate = formatDateInEST(i.start_date, false); // Format in EST (date only)
    const endDate = formatDateInEST(i.end_date, false); // Format in EST (date only)
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i.id || ''}</td><td>${i.custom_id || ''}</td><td>${i.name}</td><td>${i.status || ''}</td><td>${i.shirt_size || ''}</td><td>${i.computed_hours || 0}</td><td>${startDate}</td><td>${endDate}</td><td>${createdDate}</td><td>${updatedDate}</td><td style="white-space:nowrap;"><button onclick="window.editInitiative(${i.id})">Edit</button><button onclick="window.deleteInitiative(${i.id})" style="background:var(--red)">Del</button><button onclick="window.showAuditTrail('${i.id}', '${i.name}')">🔍</button></td>`;
    tbody.appendChild(tr);
  });

  // Update sort indicators in table headers
  document.querySelectorAll('#init-table th.sortable-th').forEach(th => {
    const arrowSpan = th.querySelector('.sort-arrow');
    if (arrowSpan) {
      arrowSpan.textContent = ''; // Clear existing arrow
      if (th.dataset.sort === sortBy) {
        arrowSpan.textContent = sortDirection === 'asc' ? ' ▲' : ' ▼';
      }
    }
  });

  // Re-attach sort event listeners after table content is rendered
  setupInitiativeTableSorting();
}

function addInitiative() {
    document.getElementById('init-id').value = '';
    document.getElementById('init-name').value = '';
    document.getElementById('init-custom-id').value = '';
    document.getElementById('init-desc').value = '';
    document.getElementById('init-priority').value = 'Low';
    document.getElementById('init-priority-num').value = '';
    document.getElementById('init-status').value = 'To Do';
    document.getElementById('init-start-date').value = '';
    document.getElementById('init-end-date').value = '';
    document.getElementById('init-scope').value = '';
    document.getElementById('init-out').value = '';
    document.getElementById('init-created').textContent = ''; // Use textContent for span
    document.getElementById('init-updated').textContent = ''; // Use textContent for span
    document.getElementById('init-calculated-shirt-size').textContent = ''; // Clear shirt size
    window.selectedFactors = [];
    window.currentInitiativeJournal = []; // Clear journal for new initiative
    renderSelectedFactorsSummary();
    renderJournalLog(); // Render empty journal
    document.getElementById('journal-comment-input').value = ''; // Clear comment input
    openModal('init');
}

function editInitiative(id) {
    console.log('editInitiative called with ID:', id);
    // Convert both the passed ID and the IDs in the list to numbers for reliable comparison
    const numericId = parseInt(id, 10);
    console.log('Parsed numeric ID:', numericId);
    console.log('Current window.initList:', window.initList);

    const init = window.initList.find(x => parseInt(x.id, 10) === numericId);
    
    if (!init) {
        console.error('Initiative not found with numeric ID:', numericId, 'Full list:', window.initList);
        showMessage('Error', 'Initiative not found. Please refresh and try again.', 'error');
        return;
    }
    console.log('Found initiative:', init);

    document.getElementById('init-id').value = init.id;
    document.getElementById('init-name').value = init.name;
    document.getElementById('init-custom-id').value = init.custom_id || '';
    document.getElementById('init-desc').value = init.description || '';
    document.getElementById('init-priority').value = init.priority || 'Low';
    document.getElementById('init-priority-num').value = init.priority_num || '';
    document.getElementById('init-status').value = init.status || 'To Do';
    document.getElementById('init-start-date').value = init.start_date ? init.start_date.substring(0, 10) : '';
    document.getElementById('init-end-date').value = init.end_date ? init.end_date.substring(0, 10) : '';
    document.getElementById('init-scope').value = init.scope || '';
    document.getElementById('init-out').value = init.out_of_scope || '';
    document.getElementById('init-created').textContent = formatDateInEST(init.created_at); // Use textContent for span
    document.getElementById('init-updated').textContent = formatDateInEST(init.updated_at); // Use textContent for span
    document.getElementById('init-calculated-shirt-size').textContent = `Calculated T-Shirt Size: ${init.shirt_size || 'N/A'} (${init.computed_hours || 0}h)`; // Display shirt size and hours
    // These fields are already parsed by the backend, so no need to parse again
    window.selectedFactors = init.selected_factors || []; 
    window.currentInitiativeJournal = init.journal_entries || []; 
    renderSelectedFactorsSummary();
    renderJournalLog(); // Render the loaded journal entries
    document.getElementById('journal-comment-input').value = ''; // Clear comment input
    openModal('init');
}
async function deleteInitiative(id){ 
  if(!confirm('Delete?')) return; 
  await fetch(API+`/api/initiatives/${id}`,{method:'DELETE'}); loadInitiatives(); 
}
async function saveInitiative(){ 
    const id=document.getElementById('init-id').value.trim(); 
    const name=document.getElementById('init-name').value.trim(); 
    if(!name){showMessage('Error', 'Name required', 'error');return;} 
    const customId=document.getElementById('init-custom-id').value.trim(); 
    const description=document.getElementById('init-desc').value.trim(); 
    const priority=document.getElementById('init-priority').value; 
    const priorityNum=+document.getElementById('init-priority-num').value||0; 
    const status=document.getElementById('init-status').value; 
    const start_date=document.getElementById('init-start-date').value.trim();
    const end_date=document.getElementById('init-end-date').value.trim();
    const classification='Internal'; 
    const scope=document.getElementById('init-scope').value.trim(); 
    const outOf=document.getElementById('init-out').value.trim(); 
    
    const payload={
        name,
        custom_id: customId,
        description,
        priority,
        priority_num: priorityNum,
        status,
        classification,
        scope,
        out_of_scope: outOf,
        selected_factors: window.selectedFactors,
        start_date: start_date || null,
        end_date: end_date || null,
        journal_entries: window.currentInitiativeJournal // Send as array, backend will stringify
    }; 
    const url=id?`/api/initiatives/${id}`:'/api/initiatives'; 
    const method=id?'PUT':'POST'; 
    const res=await fetch(API+url,{method,headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)}); 
    if (!res.ok) { showMessage('Error', 'Error:' + res.status, 'error'); return; }
    closeModal('init'); 
    loadInitiatives(); 
}

async function duplicateInitiative() {
    const originalName = document.getElementById('init-name').value.trim();
    if (!originalName) { showMessage('Error', 'Name is required to duplicate.', 'error'); return; }

    const newName = originalName + " Copy";
    const customId = document.getElementById('init-custom-id').value.trim();
    const description = document.getElementById('init-desc').value.trim();
    const priority = document.getElementById('init-priority').value;
    const priorityNum = +document.getElementById('init-priority-num').value || 0;
    const status = document.getElementById('init-status').value;
    const start_date = document.getElementById('init-start-date').value.trim();
    const end_date = document.getElementById('init-end-date').value.trim();
    const classification = 'Internal'; // Default for duplicated
    const scope = document.getElementById('init-scope').value.trim();
    const outOf = document.getElementById('init-out').value.trim();

    const newJournalEntry = {
        timestamp: new Date().toISOString(),
        type: 'audit',
        action: 'duplicated_from',
        original_name: originalName
    };

    const payload = {
        name: newName,
        custom_id: customId,
        description,
        priority,
        priority_num: priorityNum,
        status,
        classification,
        scope,
        out_of_scope: outOf,
        selected_factors: window.selectedFactors, // Copy selected factors
        start_date: start_date || null,
        end_date: end_date || null,
        journal_entries: [newJournalEntry] // Add the duplication entry
    };

    try {
        const res = await fetch(API + '/api/initiatives', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (!res.ok) {
            const errorData = await res.json();
            throw new Error(errorData.message || `Server responded with status ${res.status}`);
        }

        showMessage('Success', `Initiative "${newName}" duplicated successfully!`, 'success');
        closeModal('init');
        loadInitiatives(); // Reload the table to show the new initiative
    } catch (error) {
        console.error('Duplicate initiative failed:', error);
        showMessage('Error', 'Failed to duplicate initiative: ' + error.message, 'error');
    }
}


// Audit Trail for Initiatives
async function showAuditTrail(initiativeId, initiativeName) {
    document.getElementById('audit-title').textContent = `Audit Trail: ${initiativeName}`;
    const auditContent = document.getElementById('audit-content');
    auditContent.innerHTML = 'Loading...';
    openModal('audit');

    try {
        // Fetch the consolidated journal entries (which now include audit actions)
        const res = await fetch(API + `/api/initiatives/${initiativeId}/audit`);
        if (!res.ok) { throw new Error('Failed to fetch audit trail.'); }
        const auditLog = await res.json(); // This is now the journal_entries array
        
        auditContent.innerHTML = '';
        if (auditLog.length === 0) {
            auditContent.innerHTML = '<p>No audit history for this initiative.</p>';
        } else {
            // Sort entries by timestamp in descending order (latest first)
            const sortedAuditLog = [...auditLog].sort((a, b) => new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime());

            sortedAuditLog.forEach(entry => { // Iterate over all entries, not just filtered audit ones
                const logItem = document.createElement('div');
                logItem.className = 'audit-item';

                let details = '';
                if (entry.type === 'audit') {
                    logItem.classList.add('audit'); // Add audit class for styling
                    // Ensure oldData and newData are objects, even if they were empty strings or null
                    const oldData = typeof entry.old_data === 'object' && entry.old_data !== null ? entry.old_data : {};
                    const newData = typeof entry.new_data === 'object' && entry.new_data !== null ? entry.new_data : {};

                    if (entry.action === 'created') {
                        details = `Created with estimated hours: ${newData.computed_hours} and size: ${newData.shirt_size}.`;
                    } else if (entry.action === 'updated') {
                        // CRITICAL FIX: Ensure selected_factors are parsed into arrays
                        const oldFactors = JSON.parse(oldData.selected_factors || '[]');
                        const newFactors = JSON.parse(newData.selected_factors || '[]');

                        const diffs = [];
                        // Keys to compare for audit log (excluding internal/timestamp fields)
                        const keysToCompare = [
                            'name', 'custom_id', 'description', 'priority', 'priority_num',
                            'status', 'classification', 'scope', 'out_of_scope',
                            'computed_hours', 'shirt_size', 'start_date', 'end_date'
                        ];

                        for (const key of keysToCompare) {
                            const oldValue = oldData[key];
                            const newValue = newData[key];
                            // Special handling for date fields to compare only YYYY-MM-DD part
                            if (key === 'start_date' || key === 'end_date') {
                                const oldDate = (oldValue || '').substring(0, 10);
                                const newDate = (newValue || '').substring(0, 10);
                                if (oldDate !== newDate) {
                                    diffs.push(`- Changed ${key} from <span class="diff-removed">${oldDate}</span> to <span class="diff-added">${newDate}</span>`);
                                }
                            } else {
                                // Compare other fields directly.
                                if (oldValue !== newValue) {
                                    diffs.push(`- Changed ${key} from <span class="diff-removed">${oldValue}</span> to <span class="diff-added">${newValue}</span>`);
                                }
                            }
                        }

                        // Compare selected_factors separately
                        // Sort factors before stringifying for consistent comparison
                        // CRITICAL FIX: Ensure factorId is handled safely for localeCompare
                        const oldFactorsStr = JSON.stringify([...oldFactors].sort((a, b) => (a?.factorId || '').localeCompare(b?.factorId || '')));
                        const newFactorsStr = JSON.stringify([...newFactors].sort((a, b) => (a?.factorId || '').localeCompare(b?.factorId || '')));

                        if (oldFactorsStr !== newFactorsStr) {
                            // Detailed factor changes
                            newFactors.forEach(newFactor => {
                                const oldFactor = oldFactors.find(of => of.factorId === newFactor.factorId);
                                if (!oldFactor) {
                                    diffs.push(`- <span class="diff-added">Added factor: ${newFactor.name} (Qty: ${newFactor.quantity})</span>`);
                                } else if (oldFactor.quantity !== newFactor.quantity) {
                                    diffs.push(`- Changed quantity for factor ${newFactor.name} from <span class="diff-removed">${oldFactor.quantity}</span> to <span class="diff-added">${newFactor.quantity}</span>.`);
                                }
                            });

                            oldFactors.forEach(oldFactor => {
                                const newFactor = newFactors.find(nf => nf.factorId === oldFactor.factorId);
                                if (!newFactor) {
                                    diffs.push(`- <span class="diff-removed">Removed factor: ${oldFactor.name} (Qty: ${oldFactor.quantity})</span>`);
                                }
                            });
                        }
                        details = diffs.length > 0 ? diffs.join('<br>') : 'No changes to tracked fields.';
                    } else if (entry.action === 'deleted') {
                        details = 'Initiative was deleted.'; // This entry would only exist if we had a separate audit table for deletions
                    } else if (entry.action === 'duplicated_from') { // New audit type
                        details = `Duplicated from: ${entry.original_name}.`;
                    }
                    logItem.innerHTML = `
                        <h4>${entry.action.charAt(0).toUpperCase() + entry.action.slice(1).replace(/_/g, ' ')} on ${formatDateInEST(entry.timestamp)}</h4>
                        <p>${details}</p>
                    `;
                } else { // type === 'comment'
                    logItem.innerHTML = `
                        <h4>Comment on ${formatDateInEST(entry.timestamp)}</h4>
                        <p>${entry.text}</p>
                    `;
                }
                auditContent.appendChild(logItem);
            });
        }

    } catch (err) {
        auditContent.innerHTML = `<p style="color:var(--red);">Error fetching audit trail: ${err.message || err}</p>`;
    }
}

// Audit Trail for Estimation Factors (New)
async function showAuditTrailEF(factorId, factorName) {
    document.getElementById('ef-audit-title').textContent = `Audit Trail: ${factorName}`;
    const auditContent = document.getElementById('ef-audit-content');
    auditContent.innerHTML = 'Loading...';
    openModal('ef-audit');

    try {
        const res = await fetch(API + `/api/estimation-factors/${factorId}/audit`);
        if (!res.ok) { throw new Error('Failed to fetch estimation factor audit trail.'); }
        const auditLog = await res.json();
        
        auditContent.innerHTML = '';
        if (auditLog.length === 0) {
            auditContent.innerHTML = '<p>No audit history for this estimation factor.</p>';
        } else {
            const sortedAuditLog = [...auditLog].sort((a, b) => new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime());

            sortedAuditLog.forEach(entry => {
                const logItem = document.createElement('div');
                logItem.className = 'audit-item';

                let details = '';
                if (entry.type === 'audit') {
                    logItem.classList.add('audit');
                    // Ensure oldData and newData are objects, even if they were empty strings or null
                    const oldData = typeof entry.old_data === 'object' && entry.old_data !== null ? entry.old_data : {};
                    const newData = typeof entry.new_data === 'object' && entry.new_data !== null ? entry.new_data : {};

                    if (entry.action === 'created') {
                        details = `Created factor: ${newData.name ? newData.name : 'N/A'}.`; // Robust check for name
                    } else if (entry.action === 'updated') {
                        const diffs = [];
                        // Compare name
                        if (oldData.name !== newData.name) {
                            diffs.push(`- Changed name from <span class="diff-removed">${oldData.name || '""'}</span> to <span class="diff-added">${newData.name || '""'}</span>`);
                        }
                        // Compare description
                        if (oldData.description !== newData.description) {
                            diffs.push(`- Changed description from <span class="diff-removed">${oldData.description || '""'}</span> to <span class="diff-added">${newData.description || '""'}</span>`);
                        }

                        // Compare hoursPerResourceType
                        const oldHours = oldData.hoursPerResourceType || {};
                        const newHours = newData.hoursPerResourceType || {};

                        const allResourceIds = new Set([...Object.keys(oldHours), ...Object.keys(newHours)]);
                        allResourceIds.forEach(resId => {
                            const oldVal = oldHours[resId] || 0;
                            const newVal = newHours[resId] || 0;
                            const resourceName = window.rtList.find(r => r.id === resId)?.name || resId; // Get resource name

                            if (oldVal === 0 && newVal > 0) {
                                diffs.push(`- <span class="diff-added">Added resource ${resourceName} with ${newVal}h</span>`);
                            } else if (oldVal > 0 && newVal === 0) {
                                diffs.push(`- <span class="diff-removed">Removed resource ${resourceName} (was ${oldVal}h)</span>`);
                            } else if (oldVal !== newVal) {
                                diffs.push(`- Changed hours for ${resourceName} from <span class="diff-removed">${oldVal}h</span> to <span class="diff-added">${newVal}h</span>`);
                            }
                        });
                        details = diffs.length > 0 ? diffs.join('<br>') : 'No changes to tracked fields.';
                    } else if (entry.action === 'duplicated_from') { // New audit type
                        details = `Duplicated from: ${entry.original_name}.`;
                    }
                    logItem.innerHTML = `
                        <h4>${entry.action.charAt(0).toUpperCase() + entry.action.slice(1).replace(/_/g, ' ')} on ${formatDateInEST(entry.timestamp)}</h4>
                        <p>${details}</p>
                    `;
                } else { // type === 'comment'
                    logItem.innerHTML = `
                        <h4>Comment on ${formatDateInEST(entry.timestamp)}</h4>
                        <p>${entry.text}</p>
                    `;
                }
                auditContent.appendChild(logItem);
            });
        }

    } catch (err) {
        auditContent.innerHTML = `<p style="color:var(--red);">Error fetching audit trail: ${err.message || err}</p>`;
    }
}

async function duplicateEstimationFactor() {
    const originalName = document.getElementById('ef-name').value.trim();
    if (!originalName) { showMessage('Error', 'Name is required to duplicate.', 'error'); return; }

    const newName = originalName + " Copy";
    const description = document.getElementById('ef-description').value.trim();
    const hours = {};
    (window.rtList || []).forEach(rt => {
        const inp = document.getElementById(`ef-h-${rt.id}`);
        const sel = document.getElementById(`ef-u-${rt.id}`);
        if (inp) {
            let val = +inp.value;
            if (val > 0) {
                if (sel.value === 'd') val *= 8;
                hours[rt.id] = val;
            }
        }
    });

    const newJournalEntry = {
        timestamp: new Date().toISOString(),
        type: 'audit',
        action: 'duplicated_from',
        original_name: originalName
    };

    const payload = {
        name: newName,
        description: description,
        hoursPerResourceType: hours,
        journal_entries: [newJournalEntry] // Add the duplication entry
    };

    try {
        const res = await fetch(API + '/api/estimation-factors', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (!res.ok) {
            const errorData = await res.json();
            throw new Error(errorData.message || `Server responded with status ${res.status}`);
        }

        showMessage('Success', `Estimation Factor "${newName}" duplicated successfully!`, 'success');
        closeModal('ef');
        loadEF(); // Reload the table to show the new factor
    } catch (error) {
        console.error('Duplicate estimation factor failed:', error);
        showMessage('Error', 'Failed to duplicate estimation factor: ' + error.message, 'error');
    }
}


// Shirt Sizes Configuration
async function loadShirtSizes() {
    const res = await fetch(API + '/api/shirt-sizes');
    const sizes = await res.json();
    window.shirtSizes = sizes;
    const tbody = document.querySelector('#shirt-size-table tbody');
    tbody.innerHTML = '';
    sizes.forEach(size => {
        const days = (size.threshold_hours / 8).toFixed(1);
        const months = (size.threshold_hours / 160).toFixed(1); // Updated to 160 hours/month
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${size.size}</td><td><input type="number" min="0" value="${size.threshold_hours}" oninput="window.updateCalculatedValues(this)"></td><td id="days-${size.size}">${days}</td><td id="months-${size.size}">${months}</td>`;
        tbody.appendChild(tr);
    });
}

function updateCalculatedValues(inputElement) {
    const hours = +inputElement.value;
    const size = inputElement.closest('tr').cells[0].textContent;
    const days = (hours / 8).toFixed(1);
    const months = (hours / 160).toFixed(1); // Updated to 160 hours/month
    document.getElementById(`days-${size}`).textContent = days;
    document.getElementById(`months-${size}`).textContent = months;
}

async function saveShirtSizes() {
    const newSizes = [];
    const rows = document.querySelectorAll('#shirt-size-table tbody tr');
    rows.forEach(row => {
        const size = row.cells[0].textContent;
        const input = row.querySelector('input');
        if (input) {
            newSizes.push({ size: size, threshold_hours: +input.value });
        }
    });

    try {
        const res = await fetch(API + '/api/shirt-sizes', {
            method: 'PUT',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(newSizes)
        });
        if (!res.ok) { throw new Error('Failed to save shirt sizes.'); }
        await loadShirtSizes();
        showMessage('Success', 'Shirt sizes saved successfully.', 'success');
    } catch (err) {
        showMessage('Error', 'Error saving shirt sizes: ' + err.message, 'error');
    }
}
async function showShirtSizeAuditTrail() {
    document.getElementById('shirt-size-audit-title').textContent = `Shirt Size Audit Trail`;
    const auditContent = document.getElementById('shirt-size-audit-content');
    auditContent.innerHTML = 'Loading...';
    openModal('shirt-size-audit');
    
    try {
        const res = await fetch(API + '/api/shirt-sizes/audit');
        if (!res.ok) { throw new Error('Failed to fetch shirt size audit trail'); }
        const auditLog = await res.json();
        
        auditContent.innerHTML = '';
        if (auditLog.length === 0) {
            auditContent.innerHTML = '<p>No audit history for shirt sizes.</p>';
        } else {
            auditLog.forEach(log => {
                const logItem = document.createElement('div');
                logItem.className = 'audit-item';

                let details = '';
                if (log.action === 'updated') {
                    const oldData = JSON.parse(log.old_data);
                    const newData = JSON.parse(log.new_data);
                    
                    const diffs = [];
                    oldData.forEach(oldSize => {
                        const newSize = newData.find(ns => ns.size === oldSize.size);
                        if (newSize && oldSize.threshold_hours !== newSize.threshold_hours) {
                            diffs.push(`- Changed threshold for size ${oldSize.size} from <span class="diff-removed">${oldSize.threshold_hours}</span> to <span class="diff-added">${newSize.threshold_hours}</span>.`);
                        }
                    });
                    details = diffs.length > 0 ? diffs.join('<br>') : 'No changes to visible fields.';
                }
                
                logItem.innerHTML = `
                    <h4>${log.action} on ${formatDateInEST(log.timestamp)}</h4>
                    <p>${details}</p>
                `;
                auditContent.appendChild(logItem);
            });
        }
    } catch (err) {
        auditContent.innerHTML = `<p style="color:var(--red);">Error fetching audit trail: ${err.message}</p>`;
    }
}

// Export Initiatives
async function exportInitiatives() {
    try {
        const res = await fetch(API + '/api/initiatives');
        if (!res.ok) { throw new Error('Failed to fetch initiatives for export.'); }
        const initiatives = await res.json();

        const headers = [
            "Internal ID", "User-Defined ID", "Name", "Description", "Priority", "Priority Number",
            "Status", "Classification", "Scope", "Out of Scope",
            "Estimated Hours", "Estimated Days", "Estimated Months", "Shirt Size",
            "Start Date", "End Date",
            "Selected Factors", "Created At", "Updated At"
        ];
        
        const rows = [headers.join('\t')]; // Start with headers

        for (const initiative of initiatives) {
            const estimatedHours = initiative.computed_hours || 0;
            const estimatedDays = (estimatedHours / 8).toFixed(1);
            const estimatedMonths = (estimatedHours / 160).toFixed(1); // Updated to 160 hours/month

            let selectedFactorsSummary = '';
            if (initiative.selected_factors) {
                try {
                    // selected_factors is already an array from backend
                    selectedFactorsSummary = initiative.selected_factors.map(f => {
                        const totalFactorHours = Object.values(f.hoursPerResourceType || {}).reduce((sum, h) => sum + h, 0);
                        return `${f.name} (Qty: ${f.quantity}, Hours: ${totalFactorHours * f.quantity})`;
                    }).join(', ');
                } catch (e) {
                    console.error("Error processing selected factors for export:", e);
                    selectedFactorsSummary = "Error processing factors";
                }
            }

            const rowData = [
                initiative.id || '',
                initiative.custom_id || '',
                initiative.name || '',
                initiative.description || '',
                initiative.priority || '',
                initiative.priority_num || 0,
                initiative.status || '',
                initiative.classification || '',
                initiative.scope || '',
                initiative.out_of_scope || '',
                estimatedHours,
                estimatedDays,
                estimatedMonths,
                initiative.shirt_size || '',
                formatDateInEST(initiative.start_date, false), // Format start_date
                formatDateInEST(initiative.end_date, false),   // Format end_date
                selectedFactorsSummary,
                formatDateInEST(initiative.created_at, true),  // Format created_at
                formatDateInEST(initiative.updated_at, true)   // Format updated_at
            ];
            rows.push(rowData.map(item => {
                // Ensure no tabs or newlines within a field for TSV
                return String(item).replace(/\t/g, ' ').replace(/\n/g, ' ');
            }).join('\t'));
        }

        const tsvContent = rows.join('\n');
        const blob = new Blob([tsvContent], { type: 'text/tab-separated-values;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const now = new Date();
        const yyyy = now.getFullYear();
        const mm = String(now.getMonth() + 1).padStart(2, '0');
        const dd = String(now.getDate()).padStart(2, '0');
        const hh = String(now.getHours()).padStart(2, '0');
        const min = String(now.getMinutes()).padStart(2, '0');
        const ss = String(now.getSeconds()).padStart(2, '0');
        const filename = `initiatives_export_${yyyy}${mm}${dd}_${hh}${min}${ss}.tsv`;

        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showMessage('Success', 'Initiatives exported successfully!', 'success');

    } catch (error) {
        console.error('Export failed:', error);
        showMessage('Error', 'Failed to export initiatives: ' + error.message, 'error');
    }
}

async function exportResourceView() {
    try {
        // Ensure all necessary data is loaded
        await loadRT();
        await loadEF();
        await loadInitiatives();

        const initiatives = window.initList;
        const resourceTypes = window.rtList;
        const estimationFactors = window.efList;

        const headers = [
            "Internal ID", "User-Defined ID", "Name", "Created", "Updated", "Status", "Shirt Size",
            "Start Date", "End Date", "Resource Type", "Factor", "Factor Hours"
        ];
        const rows = [headers.join('\t')];

        for (const initiative of initiatives) {
            const createdDate = formatDateInEST(initiative.created_at, true);
            const updatedDate = formatDateInEST(initiative.updated_at, true);
            const startDate = formatDateInEST(initiative.start_date, false);
            const endDate = formatDateInEST(initiative.end_date, false);

            const baseRowData = [
                initiative.id || '', // Internal ID
                initiative.custom_id || '',
                initiative.name || '',
                createdDate,
                updatedDate,
                initiative.status || '',
                initiative.shirt_size || '',
                startDate,
                endDate
            ];

            let hasFactors = false;
            if (initiative.selected_factors) {
                // selected_factors is already an array from backend
                for (const selectedFactor of initiative.selected_factors) {
                    const factorDetails = estimationFactors.find(f => f.id === selectedFactor.factorId);
                    if (factorDetails && factorDetails.hoursPerResourceType) {
                        hasFactors = true;
                        for (const rtId in factorDetails.hoursPerResourceType) {
                            const resourceType = resourceTypes.find(rt => rt.id === rtId);
                            if (resourceType) {
                                const factorHours = factorDetails.hoursPerResourceType[rtId] * selectedFactor.quantity;
                                rows.push([
                                    ...baseRowData,
                                    resourceType.name,
                                    factorDetails.name,
                                    factorHours.toFixed(1) // Format to one decimal place
                                ].map(item => String(item).replace(/\t/g, ' ').replace(/\n</g, ' ')).join('\t'));
                            }
                        }
                    }
                }
            }

            // If no factors or no resource-specific hours, add a row with empty factor/resource data
            if (!hasFactors) {
                rows.push([
                    ...baseRowData,
                    '', // Resource Type
                    '', // Factor
                    ''  // Factor Hours
                ].map(item => String(item).replace(/\t/g, ' ').replace(/\n</g, ' ')).join('\t'));
            }
        }

        const tsvContent = rows.join('\n');
        const blob = new Blob([tsvContent], { type: 'text/tab-separated-values;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const now = new Date();
        const yyyy = now.getFullYear();
        const mm = String(now.getMonth() + 1).padStart(2, '0');
        const dd = String(now.getDate()).padStart(2, '0');
        const hh = String(now.getHours()).padStart(2, '0');
        const min = String(now.getMinutes()).padStart(2, '0');
        const ss = String(now.getSeconds()).padStart(2, '0');
        const filename = `initiatives_resource_view_export_${yyyy}${mm}${dd}_${hh}${min}${ss}.tsv`;

        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showMessage('Success', 'Resource view exported successfully!', 'success');

    } catch (error) {
        console.error('Export resource view failed:', error);
        showMessage('Error', 'Failed to export resource view: ' + error.message, 'error');
    }
}

// Import Initiatives
function importInitiatives() {
    document.getElementById('importFileInput').click();
}

async function handleImportFile(event) {
    const file = event.target.files[0];
    if (!file) {
        return;
    }

    const reader = new FileReader();
    reader.onload = async (e) => {
        try {
            const tsvContent = e.target.result;
            const lines = tsvContent.split('\n').filter(line => line.trim() !== '');

            if (lines.length === 0) {
                showMessage('Error', 'The imported file is empty.', 'error');
                return;
            }

            // Define expected headers and their corresponding initiative object keys
            // The order here matters for parsing the TSV columns
            const expectedHeaders = [
                "User-Defined ID", "Name", "Description", "Priority", "Priority Number",
                "Status", "Start Date", "End Date", "In Scope", "Out of Scope"
            ];
            
            const headerMap = {
                "User-Defined ID": "custom_id",
                "Name": "name",
                "Description": "description",
                "Priority": "priority",
                "Priority Number": "priority_num",
                "Status": "status",
                "Start Date": "start_date",
                "End Date": "end_date",
                "In Scope": "scope",
                "Out of Scope": "out_of_scope"
            };

            const fileHeaders = lines[0].split('\t').map(h => h.trim());
            const initiativesToImport = [];

            // Basic header validation (check if all expected headers are present)
            const missingHeaders = expectedHeaders.filter(header => !fileHeaders.includes(header));
            if (missingHeaders.length > 0) {
                showMessage('Error', `Missing required headers in TSV: ${missingHeaders.join(', ')}. Please ensure the TSV file has these columns.`, 'error');
                return;
            }

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split('\t');
                const initiative = {};

                for (let j = 0; j < fileHeaders.length; j++) {
                    const header = fileHeaders[j];
                    const key = headerMap[header];
                    if (key && values[j] !== undefined) {
                        let value = values[j].trim();
                        if (key === 'priority_num') {
                            initiative[key] = parseInt(value, 10) || 0;
                        } else if (key === 'start_date' || key === 'end_date') {
                            // Ensure date format is YYYY-MM-DD for backend
                            if (value) {
                                try {
                                    const date = new Date(value);
                                    if (!isNaN(date.getTime())) {
                                        initiative[key] = date.toISOString().substring(0, 10);
                                    } else {
                                        initiative[key] = null; // Invalid date
                                        console.warn(`Invalid date format for ${header}: ${value}`);
                                    }
                                } catch (e) {
                                    initiative[key] = null;
                                    console.warn(`Error parsing date for ${header}: ${value}`, e);
                                }
                            } else {
                                initiative[key] = null;
                            }
                        } else {
                            initiative[key] = value;
                        }
                    }
                }
                // Set default values for fields not in TSV or explicitly excluded
                initiative.classification = 'Imported'; // Default for imported initiatives
                initiative.selected_factors = []; // As per request, no factors on import
                initiative.journal_entries = []; // As per request, no comments on import
                initiative.status = initiative.status || 'To Do'; // Default status if not provided
                initiative.priority = initiative.priority || 'Low'; // Default priority if not provided

                initiativesToImport.push(initiative);
            }

            if (initiativesToImport.length === 0) {
                showMessage('Warning', 'No valid initiative data found in the file after parsing.', 'warning');
                return;
            }

            const res = await fetch(API + '/api/initiatives/import', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(initiativesToImport)
            });

            if (!res.ok) {
                const errorData = await res.json();
                throw new Error(errorData.message || `Server responded with status ${res.status}`);
            }

            const result = await res.json();
            showMessage('Success', `${result.importedCount} initiatives imported successfully!`, 'success');
            loadInitiatives(); // Reload the table to show new initiatives

        } catch (error) {
            console.error('Import failed:', error);
            showMessage('Error', 'Failed to import initiatives: ' + error.message, 'error');
        } finally {
            // Clear the file input value to allow re-importing the same file
            event.target.value = '';
        }
    };
    reader.readAsText(file);
}

// Function to attach event listeners for sorting
function setupInitiativeTableSorting() {
    const tableHeaders = document.querySelectorAll('#init-table th.sortable-th');
    tableHeaders.forEach(header => {
        // Remove any existing listeners to prevent duplicates
        header.removeEventListener('click', handleSortClick);
        // Add the new listener
        header.addEventListener('click', handleSortClick);
    });
}

// Handler for sort clicks
function handleSortClick(event) {
    const header = event.currentTarget;
    const sortBy = header.dataset.sort;
    if (sortBy) {
        if (currentSortColumn === sortBy) {
            currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
        } else {
            currentSortColumn = sortBy;
            currentSortDirection = 'asc'; // Default to ascending for new column
        }
        loadInitiatives(currentSortColumn, currentSortDirection);
    }
}

// Cookie Functions
function setCookie(name, value, days) {
    let expires = "";
    if (days) {
        const date = new Date();
        date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
        expires = "; expires=" + date.toUTCString();
    }
    document.cookie = name + "=" + (value || "")  + expires + "; path=/";
}

function getCookie(name) {
    const nameEQ = name + "=";
    const ca = document.cookie.split(';');
    for(let i=0; i < ca.length; i++) {
        let c = ca[i];
        while (c.charAt(0) === ' ') c = c.substring(1, c.length);
        if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
    }
    return null;
}

function loadPreferences() {
    const prefsCookie = getCookie('estiim_prefs');
    if (prefsCookie) {
        try {
            const parsedPrefs = JSON.parse(prefsCookie);
            window.userPreferences = {
                maxInitiatives: parsedPrefs.maxInitiatives || 8,
                maxResourceTypes: parsedPrefs.maxResourceTypes || 5,
                maxEstimationFactors: parsedPrefs.maxEstimationFactors || 5
            };
        }
        catch (e) {
            console.error("Error parsing preferences cookie:", e);
            window.userPreferences = { maxInitiatives: 8, maxResourceTypes: 5, maxEstimationFactors: 5 };
        }
    } else {
        window.userPreferences = { maxInitiatives: 8, maxResourceTypes: 5, maxEstimationFactors: 5 };
    }
    console.log("Loaded preferences:", window.userPreferences);
}

function savePreferences() {
    const maxInit = document.getElementById('pref-max-initiatives').value;
    const maxRT = document.getElementById('pref-max-resource-types').value;
    const maxEF = document.getElementById('pref-max-estimation-factors').value;

    window.userPreferences.maxInitiatives = parseInt(maxInit, 10) || 8;
    window.userPreferences.maxResourceTypes = parseInt(maxRT, 10) || 5;
    window.userPreferences.maxEstimationFactors = parseInt(maxEF, 10) || 5;

    setCookie('estiim_prefs', JSON.stringify(window.userPreferences), 365); // Store for 1 year
    showMessage('Success', 'Preferences saved successfully!', 'success');
    // Reload relevant sections to apply new limits
    loadInitiatives(currentSortColumn, currentSortDirection);
    loadRT();
    loadEF();
}

function populatePrefsPage() {
    document.getElementById('pref-max-initiatives').value = window.userPreferences.maxInitiatives;
    document.getElementById('pref-max-resource-types').value = window.userPreferences.maxResourceTypes;
    document.getElementById('pref-max-estimation-factors').value = window.userPreferences.maxEstimationFactors;
}


// Bootstrap
window.addEventListener('DOMContentLoaded',()=>{ 
    loadPreferences(); // Load preferences first
    loadRT().then(()=>{ loadEF(); }); 
    loadInitiatives(); 
});

</script>
</body>
</html>
